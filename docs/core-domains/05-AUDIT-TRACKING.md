# ğŸ” 05-AUDIT-TRACKING - Design Specification

> **Domain**: Cross-Cutting Concern (All Domains)  
> **Primary Pattern**: Interceptor Pattern (æ‹¦æˆªå™¨æ¨¡å¼) + Event Sourcing  
> **Pattern Study Guides**: [INTERCEPTOR-PATTERN.md](../design-patterns/INTERCEPTOR-PATTERN.md) | [DECORATOR-PATTERN.md](../design-patterns/DECORATOR-PATTERN.md)  
> **Status**: â¬œ Not Started  
> **Dependencies**: All other domains (01, 02, 03, 04)

---

## ğŸ“‹ Table of Contents

1. [Domain Overview](#domain-overview)
2. [Business Context](#business-context)
3. [Feature Specification](#feature-specification)
4. [Design Pattern Application](#design-pattern-application)
5. [Enhanced Pattern Integration](#enhanced-pattern-integration)
6. [Observability & Self-Monitoring](#observability--self-monitoring)
7. [Interface Contracts](#interface-contracts)
8. [Audit Event Specifications](#audit-event-specifications)
9. [Data Models](#data-models)
10. [Audit Data Lifecycle Management](#audit-data-lifecycle-management)
11. [Real-Time Data Pipeline](#real-time-data-pipeline)
12. [System Resilience & Deployment](#system-resilience--deployment)
13. [Compliance Requirements](#compliance-requirements)
14. [Integration Points](#integration-points)
15. [Design Pattern Ledger](#design-pattern-ledger)
16. [Implementation Roadmap](#implementation-roadmap)
17. [Study Resources](#study-resources)
18. [Acceptance Criteria](#acceptance-criteria)

---

## ğŸ¯ Domain Overview

### Purpose
The Audit Tracking domain provides **comprehensive change tracking and compliance logging** across all system operations, ensuring every data modification, access, and decision is recorded for regulatory compliance, troubleshooting, and analytics.

### Scope
| In Scope | Out of Scope |
|----------|--------------|
| Entity change tracking | Business logic implementation |
| User action logging | Authentication (handled by Identity) |
| API request/response logging | Real-time alerting (separate service) |
| Decision audit trail | Log aggregation (ELK/Splunk) |
| Compliance reporting | Performance monitoring (APM) |
| Data retention policies | Backup management |

### Business Value
- **Compliance**: Meet ISO 27001, GDPR, SOX requirements
- **Troubleshooting**: Complete trail for issue investigation
- **Security**: Detect unauthorized access or changes
- **Analytics**: Historical data for business insights
- **Accountability**: Clear ownership of every change

---

## ğŸ’¼ Business Context

### Audit Requirements by Regulation

| Regulation | Requirement | Implementation |
|------------|-------------|----------------|
| **ISO 27001** | Access logging, change tracking | All entity modifications logged |
| **GDPR** | Data access logging, right to be forgotten | PII access tracked, deletion audit |
| **SOX** | Financial data integrity | Order amounts, settlements logged |
| **Customs** | Import/export documentation | International shipment audit trail |
| **Industry** | Carrier interactions | All carrier API calls logged |

### Audit Event Categories

| Category | Examples | Retention | Access Level |
|----------|----------|-----------|--------------|
| **Security** | Login, logout, permission change | 2 years | Admin only |
| **Data Change** | Create, update, delete entities | 1 year | Admin, Auditor |
| **Business Action** | Order dispatch, carrier selection | 3 years | All users |
| **System Event** | Service start/stop, errors | 90 days | Admin, DevOps |
| **API Call** | External service interactions | 180 days | Admin, DevOps |

### Business Rules

| Rule ID | Rule Description | Implementation |
|---------|------------------|----------------|
| BR-AU-001 | All entity changes must be logged | EF Core interceptor |
| BR-AU-002 | Audit logs are immutable | Append-only storage |
| BR-AU-003 | PII access must be logged | Attribute-based tracking |
| BR-AU-004 | Failed operations must be logged | Exception interceptor |
| BR-AU-005 | Logs must include user context | ClaimsPrincipal capture |
| BR-AU-006 | Batch operations itemized | Individual change records |
| BR-AU-007 | Retention policies enforced | Scheduled cleanup jobs |

### Use Cases

#### UC-AU-001: Track Entity Change
```
Actor: System (automatic)
Precondition: Entity being saved to database
Flow:
  1. EF Core interceptor detects SaveChanges
  2. Interceptor captures changed entities
  3. For each changed entity:
     a. Record entity type, ID, operation
     b. Capture before/after values
     c. Record user, timestamp, correlation ID
  4. Audit records saved (same transaction or separate)
Postcondition: Change audit trail created
```

#### UC-AU-002: Query Audit History
```
Actor: Auditor or Admin
Precondition: User has audit access permission
Flow:
  1. User specifies search criteria (entity, date range, user)
  2. System queries audit store
  3. System returns paginated results
  4. User can drill into specific change details
Postcondition: Audit history displayed
```

#### UC-AU-003: Generate Compliance Report
```
Actor: Compliance Officer
Precondition: Audit data exists for period
Flow:
  1. User selects report type (e.g., data access report)
  2. User specifies date range
  3. System aggregates audit data
  4. System generates formatted report (PDF/Excel)
Postcondition: Compliance report generated
```

#### UC-AU-004: Investigate Incident
```
Actor: Admin or Support
Precondition: Incident reported (e.g., wrong delivery)
Flow:
  1. User enters order ID or tracking number
  2. System retrieves complete audit trail:
     - Order creation details
     - All status changes
     - Carrier interactions
     - Address modifications
  3. Timeline view shows all events
Postcondition: Complete history available for investigation
```

---

## ğŸ“ Feature Specification

### Feature Matrix

| Feature ID | Feature Name | Description | Pattern | Priority |
|------------|--------------|-------------|---------|----------|
| AU-F001 | Entity Change Tracking | Auto-track all entity changes | Interceptor | ğŸ”´ High |
| AU-F002 | User Context Capture | Record who made changes | Context | ğŸ”´ High |
| AU-F003 | Before/After Values | Store old and new values | Snapshot | ğŸ”´ High |
| AU-F004 | Correlation Tracking | Link related changes | Correlation ID | ğŸ”´ High |
| AU-F005 | API Call Logging | Log external API interactions | Middleware | ğŸŸ¡ Medium |
| AU-F006 | Decision Logging | Record algorithm decisions | Event | ğŸŸ¡ Medium |
| AU-F007 | Audit Query API | Search and filter audit logs | Query | ğŸ”´ High |
| AU-F008 | Timeline View | Chronological event view | Projection | ğŸŸ¡ Medium |
| AU-F009 | Compliance Reports | Pre-built compliance reports | Report | ğŸŸ¡ Medium |
| AU-F010 | Retention Management | Auto-cleanup old logs | Scheduler | ğŸŸ¢ Low |
| AU-F011 | PII Masking | Mask sensitive data in logs | Filter | ğŸ”´ High |
| AU-F012 | Export Capability | Export logs for external analysis | Export | ğŸŸ¢ Low |

### AU-F001: Entity Change Tracking

**Description**: Automatically capture all changes to domain entities.

**Tracked Operations**:
| Operation | Captured Data | Storage |
|-----------|---------------|---------|
| INSERT | All field values | New values only |
| UPDATE | Changed fields only | Before + After |
| DELETE | All field values | Before values only |
| SOFT DELETE | Status change | Before + After |

**Excluded from Tracking**:
- Computed properties
- Navigation properties (tracked separately)
- Explicitly marked [NotAudited] properties
- Temporary/cache entities

### AU-F003: Before/After Values

**Description**: Store the complete state change for each modification.

**Value Capture Strategy**:
```
For UPDATE operations:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Entity: Order                                             â”‚
â”‚  Property: Status                                          â”‚
â”‚  OldValue: "CREATED" (serialized)                          â”‚
â”‚  NewValue: "CONFIRMED" (serialized)                        â”‚
â”‚                                                            â”‚
â”‚  Entity: Order                                             â”‚
â”‚  Property: TotalAmount                                     â”‚
â”‚  OldValue: { "Amount": 100, "Currency": "CNY" }            â”‚
â”‚  NewValue: { "Amount": 120, "Currency": "CNY" }            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AU-F011: PII Masking

**Description**: Automatically mask sensitive data in audit logs.

**Masking Rules**:
| Data Type | Example | Masked Value |
|-----------|---------|--------------|
| Phone | 13812345678 | 138****5678 |
| Email | user@example.com | u***@example.com |
| ID Card | 110101199001011234 | 1101**********1234 |
| Bank Card | 6222021234567890123 | 6222**********0123 |
| Address | åŒ—äº¬å¸‚æœé˜³åŒºxxè¡—é“xxå· | åŒ—äº¬å¸‚æœé˜³åŒº****** |

---

## ğŸ¨ Design Pattern Application

### EF Core Interceptor Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EF CORE INTERCEPTOR PATTERN                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  Application    â”‚         â”‚   AuditInterceptor      â”‚            â”‚
â”‚  â”‚  Code           â”‚         â”‚ : SaveChangesInterceptorâ”‚            â”‚
â”‚  â”‚                 â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚  â”‚  _context       â”‚         â”‚ + SavingChanges()       â”‚            â”‚
â”‚  â”‚    .SaveChanges â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ + SavedChanges()        â”‚            â”‚
â”‚  â”‚                 â”‚         â”‚ + SaveChangesFailed()   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                          â”‚                          â”‚
â”‚                                          â”‚ captures                 â”‚
â”‚                                          â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    ChangeTracker                            â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚    â”‚
â”‚  â”‚  Entries<IAuditableEntity>()                                â”‚    â”‚
â”‚  â”‚    .Where(e => e.State == Added | Modified | Deleted)       â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â”‚  For each entry:                                            â”‚    â”‚
â”‚  â”‚    - EntityType                                             â”‚    â”‚
â”‚  â”‚    - EntityId                                               â”‚    â”‚
â”‚  â”‚    - State (Added/Modified/Deleted)                         â”‚    â”‚
â”‚  â”‚    - OriginalValues (for Modified/Deleted)                  â”‚    â”‚
â”‚  â”‚    - CurrentValues (for Added/Modified)                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                          â”‚                          â”‚
â”‚                                          â”‚ writes to                â”‚
â”‚                                          â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    AuditLog Table                           â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚    â”‚
â”‚  â”‚  Id | EntityType | EntityId | Action | OldValues | NewValuesâ”‚    â”‚
â”‚  â”‚  UserId | Timestamp | CorrelationId | IpAddress | ...       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Audit Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUDIT FLOW ARCHITECTURE                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Audit Sources                            â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ EF Core  â”‚ â”‚ API      â”‚ â”‚ Domain   â”‚ â”‚ External     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ Changes  â”‚ â”‚ Requests â”‚ â”‚ Events   â”‚ â”‚ API Calls    â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚            â”‚            â”‚              â”‚                  â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Audit Service                              â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚  + EnrichWithContext() - Add user, correlation, timestamp    â”‚   â”‚
â”‚  â”‚  + MaskSensitiveData() - PII masking                         â”‚   â”‚
â”‚  â”‚  + Classify() - Determine category and retention             â”‚   â”‚
â”‚  â”‚  + Persist() - Write to audit store                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Audit Store                                â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ SQL Server  â”‚  â”‚ Blob Storageâ”‚  â”‚ Search Index        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ (Primary)   â”‚  â”‚ (Archive)   â”‚  â”‚ (Elasticsearch)     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ Hot data    â”‚  â”‚ Cold data   â”‚  â”‚ Fast queries        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ < 90 days   â”‚  â”‚ > 90 days   â”‚  â”‚ Full-text search    â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why Interceptor Pattern?

| Benefit | Audit Application |
|---------|-------------------|
| **Transparent** | No changes to business code required |
| **Consistent** | Every save operation is captured |
| **Centralized** | Single place for audit logic |
| **Extensible** | Easy to add new audit rules |
| **Testable** | Interceptor can be tested in isolation |

---

## ï¿½ Enhanced Pattern Integration

### Performance-Optimized Interceptor Architecture (é«˜æ€§èƒ½æ‹¦æˆªå™¨æ¶æ„)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HIGH-PERFORMANCE AUDIT INTERCEPTOR                               â”‚
â”‚                    é«˜æ€§èƒ½å®¡è®¡æ‹¦æˆªå™¨æ¶æ„                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         AuditInterceptor                                     â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚   SavingChanges()                                                            â”‚   â”‚
â”‚  â”‚       â”‚                                                                      â”‚   â”‚
â”‚  â”‚       â–¼                                                                      â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚   â”‚  Object Pool (å¯¹è±¡æ± )                                                â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  â€¢ Rent AuditEntry from pool (avoid GC pressure)                    â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  â€¢ Pre-allocated buffer for serialization                           â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  â€¢ Reusable StringBuilder for JSON construction                     â”‚   â”‚   â”‚
â”‚  â”‚   â”‚                                                                     â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  Implementation:                                                    â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  private readonly ObjectPool<AuditEntry> _entryPool;                â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  private readonly ArrayPool<byte> _bufferPool;                      â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚       â”‚                                                                      â”‚   â”‚
â”‚  â”‚       â–¼                                                                      â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚   â”‚  Async Channel Queue (å¼‚æ­¥é€šé“é˜Ÿåˆ—)                                  â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚   â”‚
â”‚  â”‚   â”‚                                                                     â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  Main Thread          Channel<AuditEntry>         Background Writer â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ Capture â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚  Bounded(10000)  â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚ Batch Write â”‚  â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ Changes â”‚  async  â”‚  SingleReader    â”‚  await  â”‚ to Storage  â”‚  â”‚   â”‚   â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚
â”‚  â”‚   â”‚       â”‚                                                    â”‚       â”‚   â”‚   â”‚
â”‚  â”‚   â”‚       â”‚ Non-blocking                                       â”‚       â”‚   â”‚   â”‚
â”‚  â”‚   â”‚       â”‚ (< 1ms overhead)                        Batch size: 100    â”‚   â”‚   â”‚
â”‚  â”‚   â”‚       â”‚                                         Flush interval: 5s â”‚   â”‚   â”‚
â”‚  â”‚   â”‚       â–¼                                                    â”‚       â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   SaveChanges()                                            â”‚       â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   continues immediately                                    â”‚       â”‚   â”‚   â”‚
â”‚  â”‚   â”‚                                                            â–¼       â”‚   â”‚   â”‚
â”‚  â”‚   â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚   â”‚
â”‚  â”‚   â”‚                                              â”‚  Bulk Insert        â”‚â”‚   â”‚   â”‚
â”‚  â”‚   â”‚                                              â”‚  to AuditLog table  â”‚â”‚   â”‚   â”‚
â”‚  â”‚   â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â”‚  Benefits:                                                                           â”‚
â”‚  âœ… Main transaction NOT blocked by audit writes                                    â”‚
â”‚  âœ… Object pooling reduces GC pressure (é«˜å¹¶å‘åœºæ™¯å…³é”®)                              â”‚
â”‚  âœ… Batch writes reduce database round-trips                                        â”‚
â”‚  âœ… Bounded channel provides backpressure (é˜²æ­¢OOM)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Decorator Pattern for PII Masking (è£…é¥°å™¨æ¨¡å¼è„±æ•)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DECORATOR PATTERN FOR AUDIT PROCESSING                            â”‚
â”‚                    å®¡è®¡å¤„ç†è£…é¥°å™¨æ¨¡å¼                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  <<interface>> IAuditProcessor                                                â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  + ProcessAsync(AuditEntry entry) : Task<AuditEntry>                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â–³                                            â”‚
â”‚                                        â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚         â”‚                              â”‚                              â”‚            â”‚
â”‚         â”‚                              â”‚                              â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ CoreAuditProcessorâ”‚    â”‚ PIIMaskingDecorator  â”‚    â”‚ HashingDecorator     â”‚     â”‚
â”‚  â”‚ (æ ¸å¿ƒå®¡è®¡å¤„ç†)     â”‚    â”‚ (PIIè„±æ•è£…é¥°å™¨)       â”‚    â”‚ (å“ˆå¸Œè£…é¥°å™¨)          â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ â€¢ Serialize valuesâ”‚    â”‚ â€¢ Detect PII fields  â”‚    â”‚ â€¢ Hash sensitive IDs â”‚     â”‚
â”‚  â”‚ â€¢ Set timestamps  â”‚    â”‚ â€¢ Apply masking rulesâ”‚    â”‚ â€¢ Create integrity   â”‚     â”‚
â”‚  â”‚ â€¢ Set correlation â”‚    â”‚ â€¢ Phone: 138****5678 â”‚    â”‚   checksum           â”‚     â”‚
â”‚  â”‚                   â”‚    â”‚ â€¢ Email: u***@xx.com â”‚    â”‚                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                      â”‚
â”‚  Decoration Chain (è£…é¥°é“¾):                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                                             â”‚    â”‚
â”‚  â”‚  AuditEntry â”€â”€â–¶ HashingDecorator â”€â”€â–¶ PIIMaskingDecorator â”€â”€â–¶ CoreProcessor  â”‚    â”‚
â”‚  â”‚                                                                             â”‚    â”‚
â”‚  â”‚  Order of decoration matters:                                               â”‚    â”‚
â”‚  â”‚  1. Hashing first (on raw data)                                             â”‚    â”‚
â”‚  â”‚  2. PII masking second (for storage)                                        â”‚    â”‚
â”‚  â”‚  3. Core processing last (serialize & persist)                              â”‚    â”‚
â”‚  â”‚                                                                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                      â”‚
â”‚  Configuration:                                                                      â”‚
â”‚  services.AddScoped<IAuditProcessor>(sp =>                                          â”‚
â”‚      new HashingDecorator(                                                          â”‚
â”‚          new PIIMaskingDecorator(                                                   â”‚
â”‚              new CoreAuditProcessor(sp.GetService<IAuditStore>()))));               â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Chain of Responsibility for PII Discovery (è´£ä»»é“¾æ¨¡å¼PIIå‘ç°)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PII DISCOVERY CHAIN (PIIå‘ç°è´£ä»»é“¾)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  Input: Field name + value                                                          â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Attribute   â”‚â”€â”€â”€â–¶â”‚   Regex      â”‚â”€â”€â”€â–¶â”‚   ML-Based   â”‚â”€â”€â”€â–¶â”‚   Default    â”‚      â”‚
â”‚  â”‚  Handler     â”‚    â”‚   Handler    â”‚    â”‚   Handler    â”‚    â”‚   Handler    â”‚      â”‚
â”‚  â”‚              â”‚    â”‚              â”‚    â”‚              â”‚    â”‚              â”‚      â”‚
â”‚  â”‚ [SensitiveData]   â”‚ Phone patternâ”‚    â”‚ NER model    â”‚    â”‚ No masking   â”‚      â”‚
â”‚  â”‚ attribute?   â”‚    â”‚ Email patternâ”‚    â”‚ for names,   â”‚    â”‚ (pass through)      â”‚
â”‚  â”‚              â”‚    â”‚ IDCard pattern    â”‚ addresses    â”‚    â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                   â”‚                   â”‚                   â”‚              â”‚
â”‚         â”‚ handled?          â”‚ handled?          â”‚ handled?          â”‚              â”‚
â”‚         â–¼                   â–¼                   â–¼                   â–¼              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚    â”‚ Mask &  â”‚         â”‚ Mask &  â”‚         â”‚ Mask &  â”‚         â”‚ Return  â”‚        â”‚
â”‚    â”‚ Return  â”‚         â”‚ Return  â”‚         â”‚ Return  â”‚         â”‚ as-is   â”‚        â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                                      â”‚
â”‚  PII Patterns (æ­£åˆ™æ¨¡å¼):                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Type        â”‚ Pattern                              â”‚ Mask Result           â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚
â”‚  â”‚  Phone (CN)  â”‚ 1[3-9]\d{9}                          â”‚ 138****5678           â”‚    â”‚
â”‚  â”‚  Email       â”‚ [\w.-]+@[\w.-]+                       â”‚ u***@example.com      â”‚    â”‚
â”‚  â”‚  ID Card     â”‚ \d{17}[\dXx]                          â”‚ 1101**********1234    â”‚    â”‚
â”‚  â”‚  Bank Card   â”‚ \d{16,19}                             â”‚ 6222**********0123    â”‚    â”‚
â”‚  â”‚  IP Address  â”‚ \d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}  â”‚ 192.168.***.***       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Strategy Pattern for Storage (ç­–ç•¥æ¨¡å¼å­˜å‚¨)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STORAGE STRATEGY PATTERN (å­˜å‚¨ç­–ç•¥æ¨¡å¼)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  <<interface>> IAuditStorageStrategy                                         â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  + SerializeAsync(AuditEntry entry) : Task<byte[]>                           â”‚   â”‚
â”‚  â”‚  + StoreAsync(byte[] data) : Task                                            â”‚   â”‚
â”‚  â”‚  + QueryAsync(AuditQuery query) : Task<IEnumerable<AuditLog>>                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        ^                                            â”‚
â”‚                                        â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚                              â”‚                              â”‚             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ SqlServerStrategyâ”‚    â”‚ CosmosDbStrategy     â”‚    â”‚ BlobArchiveStrategy  â”‚        â”‚
â”‚  â”‚ (çƒ­æ•°æ® <90å¤©)    â”‚    â”‚ (é«˜åååœºæ™¯)          â”‚    â”‚ (å†·æ•°æ®å½’æ¡£)          â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ â€¢ JSON serialize â”‚    â”‚ â€¢ BSON serialize     â”‚    â”‚ â€¢ Parquet format     â”‚     â”‚
â”‚  â”‚ â€¢ Complex queriesâ”‚    â”‚ â€¢ Partition by date  â”‚    â”‚ â€¢ Compressed storage â”‚     â”‚
â”‚  â”‚ â€¢ ACID complianceâ”‚    â”‚ â€¢ Auto-scale RU      â”‚    â”‚ â€¢ Low-cost retention â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                      â”‚
â”‚  Strategy Selection (ç­–ç•¥é€‰æ‹©):                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  public class AuditStorageSelector                                          â”‚    â”‚
â”‚  â”‚  {                                                                          â”‚    â”‚
â”‚  â”‚      public IAuditStorageStrategy SelectStrategy(AuditEntry entry)          â”‚    â”‚
â”‚  â”‚      {                                                                      â”‚    â”‚
â”‚  â”‚          // High-volume entities â†’ CosmosDB                                 â”‚    â”‚
â”‚  â”‚          if (entry.EntityType is "TrackingEvent" or "LocationUpdate")       â”‚    â”‚
â”‚  â”‚              return _cosmosStrategy;                                        â”‚    â”‚
â”‚  â”‚                                                                             â”‚    â”‚
â”‚  â”‚          // Compliance-critical â†’ SQL Server                                â”‚    â”‚
â”‚  â”‚          if (entry.Category == AuditCategory.Compliance)                    â”‚    â”‚
â”‚  â”‚              return _sqlStrategy;                                           â”‚    â”‚
â”‚  â”‚                                                                             â”‚    â”‚
â”‚  â”‚          // Old data â†’ Blob Archive                                         â”‚    â”‚
â”‚  â”‚          if (entry.Timestamp < DateTime.UtcNow.AddDays(-90))                â”‚    â”‚
â”‚  â”‚              return _blobStrategy;                                          â”‚    â”‚
â”‚  â”‚                                                                             â”‚    â”‚
â”‚  â”‚          return _sqlStrategy; // Default                                    â”‚    â”‚
â”‚  â”‚      }                                                                      â”‚    â”‚
â”‚  â”‚  }                                                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Observability & Self-Monitoring

### Audit System Health Metrics (å®¡è®¡ç³»ç»Ÿå¥åº·æŒ‡æ ‡)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUDIT OBSERVABILITY DASHBOARD                                     â”‚
â”‚                    å®¡è®¡å¯è§‚æµ‹æ€§ä»ªè¡¨æ¿                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘                         HEALTH METRICS (å¥åº·æŒ‡æ ‡)                              â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘  â”‚
â”‚  â•‘  â”‚ Write Success Rate  â”‚  â”‚ Processing Latency  â”‚  â”‚ Queue Backlog       â”‚   â•‘  â”‚
â”‚  â•‘  â”‚                     â”‚  â”‚                     â”‚  â”‚                     â”‚   â•‘  â”‚
â”‚  â•‘  â”‚      99.97%         â”‚  â”‚   p50: 2ms          â”‚  â”‚      127            â”‚   â•‘  â”‚
â”‚  â•‘  â”‚      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘      â”‚  â”‚   p95: 15ms         â”‚  â”‚      â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘     â”‚   â•‘  â”‚
â”‚  â•‘  â”‚                     â”‚  â”‚   p99: 45ms         â”‚  â”‚      (of 10000)     â”‚   â•‘  â”‚
â”‚  â•‘  â”‚  Target: >99.9%     â”‚  â”‚   Target: <50ms     â”‚  â”‚  Target: <1000      â”‚   â•‘  â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                                      â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘                         DATA OVERVIEW (æ•°æ®æ¦‚å†µ)                               â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  Daily Event Volume: 2.5M events                                              â•‘  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘  â”‚
â”‚  â•‘  â”‚  By Entity Type                    â”‚  By Operation                      â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  Order          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  35%  â”‚  Create    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    28%          â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  Shipment       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     25%  â”‚  Update    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  55%     â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  TrackingEvent  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      22%  â”‚  Delete    â–ˆâ–ˆ           7%          â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  Customer       â–ˆâ–ˆâ–ˆ           10%  â”‚  Access    â–ˆâ–ˆâ–ˆâ–ˆ        10%          â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  Other          â–ˆâ–ˆ            8%   â”‚                                     â”‚  â•‘  â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                                      â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘                         SYSTEM LOAD (ç³»ç»Ÿè´Ÿè·)                                 â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  Storage Growth Trend (å­˜å‚¨å¢é•¿è¶‹åŠ¿):                                          â•‘  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘  â”‚
â”‚  â•‘  â”‚  250GB â”¤                                                           â•±    â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  200GB â”¤                                                      â•±â”€â”€â”€â•±     â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  150GB â”¤                                              â•±â”€â”€â”€â”€â”€â”€â•±          â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  100GB â”¤                                    â•±â”€â”€â”€â”€â”€â”€â”€â”€â•±                  â”‚  â•‘  â”‚
â”‚  â•‘  â”‚   50GB â”¤                        â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•±                            â”‚  â•‘  â”‚
â”‚  â•‘  â”‚    0GB â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â•‘  â”‚
â”‚  â•‘  â”‚        Jan    Feb    Mar    Apr    May    Jun    Jul                    â”‚  â•‘  â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  Query API Metrics:                                                           â•‘  â”‚
â”‚  â•‘  â€¢ QPS: 450 req/s  â”‚  Avg Response: 120ms  â”‚  Error Rate: 0.02%              â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Alert Rules (å‘Šè­¦è§„åˆ™)

| Alert Name | Condition | Severity | Action |
|------------|-----------|----------|--------|
| **AuditWriteFailure** | Write success rate < 99% | ğŸ”´ Critical | Page on-call, investigate immediately |
| **HighProcessingLatency** | p99 latency > 100ms for 5 min | ğŸŸ¡ Warning | Check queue depth, scale workers |
| **QueueBacklogHigh** | Queue depth > 5000 for 10 min | ğŸŸ¡ Warning | Scale consumers, check storage |
| **MissingOrderEvents** | No Order audit events for 5 min | ğŸ”´ Critical | Verify interceptor health |
| **StorageGrowthAnomaly** | Growth > 150% of 7-day avg | ğŸŸ¡ Warning | Review retention, check duplicates |
| **QueryAPISlowdown** | Avg response > 500ms | ğŸŸ¡ Warning | Check indexes, scale read replicas |

### Metrics Collection (æŒ‡æ ‡é‡‡é›†)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    METRICS COLLECTION ARCHITECTURE                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚
â”‚  â”‚  AuditInterceptor â”‚                                                               â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                                                               â”‚
â”‚  â”‚  â€¢ audit_write_total{status="success|failure"}                                   â”‚
â”‚  â”‚  â€¢ audit_write_duration_seconds{quantile="0.5|0.95|0.99"}                        â”‚
â”‚  â”‚  â€¢ audit_queue_depth                                                             â”‚
â”‚  â”‚  â€¢ audit_batch_size                                                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                               â”‚
â”‚           â”‚                                                                          â”‚
â”‚           â”‚ Prometheus metrics                                                       â”‚
â”‚           â–¼                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   Prometheus     â”‚â”€â”€â”€â–¶â”‚    Grafana       â”‚â”€â”€â”€â–¶â”‚   Alert Manager  â”‚              â”‚
â”‚  â”‚   (æ”¶é›†)          â”‚    â”‚   (å¯è§†åŒ–)        â”‚    â”‚   (å‘Šè­¦)          â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                      â”‚
â”‚  Key Metrics Definition:                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  // Counters                                                                â”‚    â”‚
â”‚  â”‚  audit_events_total{entity_type, action, category}                          â”‚    â”‚
â”‚  â”‚  audit_write_failures_total{error_type}                                     â”‚    â”‚
â”‚  â”‚                                                                             â”‚    â”‚
â”‚  â”‚  // Gauges                                                                  â”‚    â”‚
â”‚  â”‚  audit_queue_depth                                                          â”‚    â”‚
â”‚  â”‚  audit_storage_bytes{tier="hot|warm|cold"}                                  â”‚    â”‚
â”‚  â”‚                                                                             â”‚    â”‚
â”‚  â”‚  // Histograms                                                              â”‚    â”‚
â”‚  â”‚  audit_write_latency_seconds                                                â”‚    â”‚
â”‚  â”‚  audit_query_latency_seconds                                                â”‚    â”‚
â”‚  â”‚  audit_serialization_bytes                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ï¿½ğŸ“œ Interface Contracts

### IAuditableEntity (Marker Interface)

```
Interface: IAuditableEntity
Namespace: DT.Express.Domain.Common
Purpose: Mark entities for automatic audit tracking

Properties:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DateTime CreatedAt { get; set; }                           â”‚
â”‚   - When entity was created                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ string CreatedBy { get; set; }                             â”‚
â”‚   - User who created entity                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DateTime UpdatedAt { get; set; }                           â”‚
â”‚   - Last modification time                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ string UpdatedBy { get; set; }                             â”‚
â”‚   - User who last modified                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### IAuditService (Application Service)

```
Interface: IAuditService
Namespace: DT.Express.Application.Services
Purpose: Query and manage audit logs

Methods:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Task<PagedResult<AuditLogDto>> QueryLogsAsync(             â”‚
â”‚     AuditQueryRequest query)                               â”‚
â”‚   - Query audit logs with filters                          â”‚
â”‚   - Supports: entity type, date range, user, action        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Task<List<AuditLogDto>> GetEntityHistoryAsync(             â”‚
â”‚     string entityType, string entityId)                    â”‚
â”‚   - Get complete history for one entity                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Task<AuditTimelineDto> GetTimelineAsync(                   â”‚
â”‚     string correlationId)                                  â”‚
â”‚   - Get all events for a business operation                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Task<ComplianceReportDto> GenerateReportAsync(             â”‚
â”‚     ReportType type, DateRange range)                      â”‚
â”‚   - Generate compliance report                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Task LogCustomEventAsync(AuditEvent auditEvent)            â”‚
â”‚   - Log custom business event (not entity change)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AuditInterceptor (EF Core Interceptor)

```
Class: AuditInterceptor
Inherits: SaveChangesInterceptor
Namespace: DT.Express.Infrastructure.Audit
Purpose: Capture entity changes during SaveChanges

Methods:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ InterceptionResult<int> SavingChanges(                     â”‚
â”‚     DbContextEventData eventData,                          â”‚
â”‚     InterceptionResult<int> result)                        â”‚
â”‚   - Called before SaveChanges executes                     â”‚
â”‚   - Capture original values for modified entities          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ int SavedChanges(                                          â”‚
â”‚     SaveChangesCompletedEventData eventData,               â”‚
â”‚     int result)                                            â”‚
â”‚   - Called after SaveChanges succeeds                      â”‚
â”‚   - Persist audit records                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ void SaveChangesFailed(                                    â”‚
â”‚     DbContextErrorEventData eventData)                     â”‚
â”‚   - Called when SaveChanges fails                          â”‚
â”‚   - Log failed operation attempt                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Private Methods:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ List<AuditEntry> CaptureChanges(ChangeTracker tracker)     â”‚
â”‚   - Extract changed entities from tracker                  â”‚
â”‚   - Build audit entries with before/after values           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AuditContext GetAuditContext()                             â”‚
â”‚   - Get current user from HttpContext                      â”‚
â”‚   - Get correlation ID from headers                        â”‚
â”‚   - Get client IP address                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¨ Audit Event Specifications

### Event: EntityChanged

```
Event: EntityChanged
Category: Data Change
Trigger: Entity added, modified, or deleted

Payload:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Id             â”‚ Guid           â”‚ Unique audit ID         â”‚
â”‚  EntityType     â”‚ string         â”‚ "Order", "Shipment"     â”‚
â”‚  EntityId       â”‚ string         â”‚ Primary key value       â”‚
â”‚  Action         â”‚ AuditAction    â”‚ Create/Update/Delete    â”‚
â”‚  OldValues      â”‚ JsonDocument   â”‚ Values before (if any)  â”‚
â”‚  NewValues      â”‚ JsonDocument   â”‚ Values after (if any)   â”‚
â”‚  ChangedFields  â”‚ List<string>   â”‚ Modified properties     â”‚
â”‚  UserId         â”‚ string         â”‚ Who made the change     â”‚
â”‚  UserName       â”‚ string         â”‚ Display name            â”‚
â”‚  Timestamp      â”‚ DateTime       â”‚ When it happened        â”‚
â”‚  CorrelationId  â”‚ string         â”‚ Request correlation     â”‚
â”‚  IpAddress      â”‚ string         â”‚ Client IP               â”‚
â”‚  UserAgent      â”‚ string         â”‚ Client info             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Event: BusinessAction

```
Event: BusinessAction
Category: Business Action
Trigger: Significant business operation

Payload:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Id             â”‚ Guid           â”‚ Unique audit ID         â”‚
â”‚  ActionType     â”‚ string         â”‚ "OrderDispatched", etc  â”‚
â”‚  EntityType     â”‚ string         â”‚ Related entity type     â”‚
â”‚  EntityId       â”‚ string         â”‚ Related entity ID       â”‚
â”‚  Description    â”‚ string         â”‚ Human-readable summary  â”‚
â”‚  Details        â”‚ JsonDocument   â”‚ Action-specific data    â”‚
â”‚  UserId         â”‚ string         â”‚ Who performed action    â”‚
â”‚  Timestamp      â”‚ DateTime       â”‚ When performed          â”‚
â”‚  CorrelationId  â”‚ string         â”‚ Request correlation     â”‚
â”‚  Outcome        â”‚ string         â”‚ Success/Failure/Partial â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Examples:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ActionType: "CarrierSelected"                             â”‚
â”‚  EntityType: "Shipment"                                    â”‚
â”‚  EntityId: "abc-123"                                       â”‚
â”‚  Details: {                                                â”‚
â”‚    "SelectedCarrier": "SF",                                â”‚
â”‚    "Reason": "Lowest cost",                                â”‚
â”‚    "AlternativesConsidered": ["JD", "ZTO"],               â”‚
â”‚    "Quote": 15.50                                          â”‚
â”‚  }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Event: ExternalApiCall

```
Event: ExternalApiCall
Category: API Call
Trigger: Call to external service

Payload:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Id             â”‚ Guid           â”‚ Unique audit ID         â”‚
â”‚  ServiceName    â”‚ string         â”‚ "SFExpress", "Amap"     â”‚
â”‚  Endpoint       â”‚ string         â”‚ API endpoint called     â”‚
â”‚  Method         â”‚ string         â”‚ GET/POST/PUT            â”‚
â”‚  RequestBody    â”‚ string         â”‚ Sanitized request       â”‚
â”‚  ResponseStatus â”‚ int            â”‚ HTTP status code        â”‚
â”‚  ResponseBody   â”‚ string         â”‚ Sanitized response      â”‚
â”‚  DurationMs     â”‚ long           â”‚ Call duration           â”‚
â”‚  Timestamp      â”‚ DateTime       â”‚ When called             â”‚
â”‚  CorrelationId  â”‚ string         â”‚ Request correlation     â”‚
â”‚  Success        â”‚ bool           â”‚ Whether call succeeded  â”‚
â”‚  ErrorMessage   â”‚ string         â”‚ Error if failed         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Models

### AuditLog (Primary Storage)

| Property | Type | Description |
|----------|------|-------------|
| Id | Guid | Unique identifier |
| EntityType | string | Entity class name |
| EntityId | string | Primary key (string for flexibility) |
| Action | AuditAction | Create/Update/Delete |
| OldValues | string (JSON) | Serialized old values |
| NewValues | string (JSON) | Serialized new values |
| ChangedFields | string | Comma-separated field names |
| UserId | string | User identifier |
| UserName | string | User display name |
| Timestamp | DateTime | UTC timestamp |
| CorrelationId | string | Request tracking ID |
| IpAddress | string | Client IP |
| UserAgent | string | Client browser/app |
| Category | AuditCategory | Classification |
| Severity | AuditSeverity | Info/Warning/Critical |

### AuditAction (Enum)

| Value | Name | Description |
|-------|------|-------------|
| 0 | Create | New entity created |
| 1 | Update | Entity modified |
| 2 | Delete | Entity deleted |
| 3 | SoftDelete | Entity marked deleted |
| 4 | Access | Entity accessed/viewed |
| 5 | Export | Data exported |

### AuditCategory (Enum)

| Value | Name | Retention | Examples |
|-------|------|-----------|----------|
| 0 | Security | 2 years | Login, permission change |
| 1 | DataChange | 1 year | Entity CRUD |
| 2 | BusinessAction | 3 years | Dispatch, delivery |
| 3 | SystemEvent | 90 days | Service events |
| 4 | ApiCall | 180 days | External API |
| 5 | Compliance | 7 years | Financial, customs |

### AuditQueryRequest (Query DTO)

| Property | Type | Description |
|----------|------|-------------|
| EntityType | string | Filter by entity type |
| EntityId | string | Filter by specific entity |
| Action | AuditAction? | Filter by action |
| UserId | string | Filter by user |
| StartDate | DateTime | Date range start |
| EndDate | DateTime | Date range end |
| SearchTerm | string | Full-text search |
| Category | AuditCategory? | Filter by category |
| Page | int | Pagination |
| PageSize | int | Page size |
| SortBy | string | Sort field |
| SortDesc | bool | Sort direction |

---

## ï¿½ Audit Data Lifecycle Management

### Tiered Storage Architecture (åˆ†å±‚å­˜å‚¨æ¶æ„)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TIERED STORAGE ARCHITECTURE (åˆ†å±‚å­˜å‚¨)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                              DATA FLOW                                        â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚   New Audit Event                                                            â”‚   â”‚
â”‚  â”‚        â”‚                                                                     â”‚   â”‚
â”‚  â”‚        â–¼                                                                     â”‚   â”‚
â”‚  â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚   â”‚
â”‚  â”‚   â•‘  HOT TIER (çƒ­æ•°æ®å±‚)                                      < 90 days   â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  Storage: Azure SQL Database / SQL Server                            â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  Features:                                                           â•‘ â”‚   â”‚
â”‚  â”‚   â•‘    â€¢ Full indexing for fast queries                                  â•‘ â”‚   â”‚
â”‚  â”‚   â•‘    â€¢ Complex filters and aggregations                                â•‘ â”‚   â”‚
â”‚  â”‚   â•‘    â€¢ Real-time dashboard support                                     â•‘ â”‚   â”‚
â”‚  â”‚   â•‘    â€¢ ACID compliance for recent data                                 â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  Cost: $$$$ (premium storage)                                        â•‘ â”‚   â”‚
â”‚  â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚   â”‚
â”‚  â”‚                                              â”‚                               â”‚   â”‚
â”‚  â”‚                                              â”‚ 90-day archive job            â”‚   â”‚
â”‚  â”‚                                              â–¼                               â”‚   â”‚
â”‚  â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚   â”‚
â”‚  â”‚   â•‘  WARM TIER (æ¸©æ•°æ®å±‚)                              90 days - 2 years  â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  Storage: Azure Blob Cool / AWS S3 Infrequent Access                 â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  Format: Parquet files (compressed, columnar)                        â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  Features:                                                           â•‘ â”‚   â”‚
â”‚  â”‚   â•‘    â€¢ Partitioned by date (year/month/day)                            â•‘ â”‚   â”‚
â”‚  â”‚   â•‘    â€¢ Indexed via Azure Data Lake / Athena                            â•‘ â”‚   â”‚
â”‚  â”‚   â•‘    â€¢ Query latency: seconds (acceptable for investigation)           â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  Cost: $$ (cool storage)                                             â•‘ â”‚   â”‚
â”‚  â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚   â”‚
â”‚  â”‚                                              â”‚                               â”‚   â”‚
â”‚  â”‚                                              â”‚ 2-year archive job            â”‚   â”‚
â”‚  â”‚                                              â–¼                               â”‚   â”‚
â”‚  â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚   â”‚
â”‚  â”‚   â•‘  COLD TIER (å†·æ•°æ®å±‚)                              2 years - 7 years  â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  Storage: Azure Archive / AWS Glacier                                â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  Features:                                                           â•‘ â”‚   â”‚
â”‚  â”‚   â•‘    â€¢ Compliance retention only                                       â•‘ â”‚   â”‚
â”‚  â”‚   â•‘    â€¢ Retrieval requires hours (acceptable for audits)                â•‘ â”‚   â”‚
â”‚  â”‚   â•‘    â€¢ WORM (Write Once Read Many) for tamper-proof                    â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  Cost: $ (archive storage)                                           â•‘ â”‚   â”‚
â”‚  â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚   â”‚
â”‚  â”‚                                              â”‚                               â”‚   â”‚
â”‚  â”‚                                              â”‚ Retention expiry              â”‚   â”‚
â”‚  â”‚                                              â–¼                               â”‚   â”‚
â”‚  â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚   â”‚
â”‚  â”‚   â•‘  SECURE DELETION (å®‰å…¨åˆ é™¤)                           > retention    â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  â€¢ Cryptographic erasure (delete encryption keys)                    â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  â€¢ Audit of deletion (meta-audit)                                    â•‘ â”‚   â”‚
â”‚  â”‚   â•‘  â€¢ GDPR complianceè¯æ˜                                               â•‘ â”‚   â”‚
â”‚  â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Retention Policy by Category (æŒ‰ç±»åˆ«ä¿ç•™ç­–ç•¥)

| Category | Hot (SQL) | Warm (Blob) | Cold (Archive) | Total Retention | GDPR Handling |
|----------|-----------|-------------|----------------|-----------------|---------------|
| Security | 90 days | 1 year | 1 year | **2 years** | Anonymize after 2y |
| DataChange | 90 days | 9 months | - | **1 year** | Delete on request |
| BusinessAction | 90 days | 2 years | 1 year | **3 years** | Anonymize user |
| SystemEvent | 90 days | - | - | **90 days** | Auto-delete |
| ApiCall | 90 days | 3 months | - | **180 days** | Auto-delete |
| Compliance | 90 days | 2 years | 5 years | **7 years** | Immutable |

### Lifecycle Management Service (ç”Ÿå‘½å‘¨æœŸç®¡ç†æœåŠ¡)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUDIT LIFECYCLE SERVICE                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  public class AuditLifecycleService : IHostedService                                â”‚
â”‚  {                                                                                  â”‚
â”‚      // Scheduled jobs (é…åˆHangfire/Quartz)                                        â”‚
â”‚                                                                                      â”‚
â”‚      [Cron("0 2 * * *")]  // Daily at 2 AM                                          â”‚
â”‚      public async Task ArchiveHotToWarmAsync()                                       â”‚
â”‚      {                                                                              â”‚
â”‚          var cutoff = DateTime.UtcNow.AddDays(-90);                                 â”‚
â”‚          var records = await _hotStorage.QueryOlderThanAsync(cutoff);               â”‚
â”‚                                                                                      â”‚
â”‚          // Convert to Parquet and upload to Blob                                   â”‚
â”‚          var parquetData = ConvertToParquet(records);                               â”‚
â”‚          await _warmStorage.UploadAsync(                                            â”‚
â”‚              $"audit/{cutoff:yyyy}/{cutoff:MM}/{cutoff:dd}.parquet",                â”‚
â”‚              parquetData);                                                          â”‚
â”‚                                                                                      â”‚
â”‚          // Delete from hot storage (keep in Blob)                                  â”‚
â”‚          await _hotStorage.DeleteOlderThanAsync(cutoff);                            â”‚
â”‚                                                                                      â”‚
â”‚          _metrics.RecordArchiveJob("hot_to_warm", records.Count);                   â”‚
â”‚      }                                                                              â”‚
â”‚                                                                                      â”‚
â”‚      [Cron("0 3 1 * *")]  // Monthly on 1st at 3 AM                                 â”‚
â”‚      public async Task ArchiveWarmToColdAsync()                                      â”‚
â”‚      {                                                                              â”‚
â”‚          // Similar logic for 2-year-old data                                       â”‚
â”‚      }                                                                              â”‚
â”‚                                                                                      â”‚
â”‚      [Cron("0 4 1 * *")]  // Monthly on 1st at 4 AM                                 â”‚
â”‚      public async Task PurgeExpiredAsync()                                           â”‚
â”‚      {                                                                              â”‚
â”‚          foreach (var category in Enum.GetValues<AuditCategory>())                  â”‚
â”‚          {                                                                          â”‚
â”‚              var retention = GetRetentionPolicy(category);                          â”‚
â”‚              var cutoff = DateTime.UtcNow.Add(-retention.TotalRetention);           â”‚
â”‚                                                                                      â”‚
â”‚              await _coldStorage.DeleteOlderThanAsync(category, cutoff);             â”‚
â”‚                                                                                      â”‚
â”‚              // Log the purge itself (meta-audit)                                   â”‚
â”‚              await _auditService.LogCustomEventAsync(new AuditEvent                 â”‚
â”‚              {                                                                      â”‚
â”‚                  ActionType = "AuditDataPurged",                                    â”‚
â”‚                  Details = new { Category = category, Cutoff = cutoff }             â”‚
â”‚              });                                                                    â”‚
â”‚          }                                                                          â”‚
â”‚      }                                                                              â”‚
â”‚  }                                                                                  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### GDPR "Right to be Forgotten" Handling (GDPRè¢«é—å¿˜æƒå¤„ç†)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GDPR ERASURE REQUEST HANDLING                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  Policy: Audit records are NOT physically deleted (breaks audit integrity)          â”‚
â”‚          Instead, we ANONYMIZE the user reference                                    â”‚
â”‚                                                                                      â”‚
â”‚  Before Anonymization:                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  {                                                                          â”‚    â”‚
â”‚  â”‚    "EntityType": "Order",                                                   â”‚    â”‚
â”‚  â”‚    "Action": "Create",                                                      â”‚    â”‚
â”‚  â”‚    "UserId": "user-12345",                                                  â”‚    â”‚
â”‚  â”‚    "UserName": "å¼ ä¸‰",                                                       â”‚    â”‚
â”‚  â”‚    "IpAddress": "192.168.1.100",                                            â”‚    â”‚
â”‚  â”‚    "NewValues": { "CustomerName": "æå››", "Phone": "13812345678" }           â”‚    â”‚
â”‚  â”‚  }                                                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                      â”‚
â”‚  After Anonymization:                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  {                                                                          â”‚    â”‚
â”‚  â”‚    "EntityType": "Order",                                                   â”‚    â”‚
â”‚  â”‚    "Action": "Create",                                                      â”‚    â”‚
â”‚  â”‚    "UserId": "[ANONYMIZED-a1b2c3]",       // Hashed reference               â”‚    â”‚
â”‚  â”‚    "UserName": "[ANONYMIZED]",                                              â”‚    â”‚
â”‚  â”‚    "IpAddress": "[ANONYMIZED]",                                             â”‚    â”‚
â”‚  â”‚    "NewValues": { "CustomerName": "[ANONYMIZED]", "Phone": "[ANONYMIZED]" } â”‚    â”‚
â”‚  â”‚    "GdprAnonymizedAt": "2026-02-01T10:30:00Z",                              â”‚    â”‚
â”‚  â”‚    "GdprRequestId": "REQ-789456"                                            â”‚    â”‚
â”‚  â”‚  }                                                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                      â”‚
â”‚  Benefits:                                                                          â”‚
â”‚  âœ… Audit trail remains intact (WHO did something becomes "someone")                â”‚
â”‚  âœ… GDPR compliance achieved (PII removed)                                          â”‚
â”‚  âœ… Audit of anonymization itself recorded                                          â”‚
â”‚  âœ… Can still query by EntityId, Action, Timestamp                                  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒŠ Real-Time Data Pipeline

### Audit Event Streaming Architecture (å®¡è®¡äº‹ä»¶æµæ¶æ„)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REAL-TIME AUDIT DATA PIPELINE                                     â”‚
â”‚                    å®æ—¶å®¡è®¡æ•°æ®ç®¡é“                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚                         â”‚  Audit Events   â”‚                                         â”‚
â”‚                         â”‚  (from all      â”‚                                         â”‚
â”‚                         â”‚   domains)      â”‚                                         â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                                  â”‚                                                   â”‚
â”‚                                  â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    EVENT HUB / KAFKA (äº‹ä»¶ä¸­å¿ƒ)                               â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚  Topic: audit-events                                                         â”‚   â”‚
â”‚  â”‚  Partitions: 16 (by EntityType hash for ordering)                            â”‚   â”‚
â”‚  â”‚  Retention: 7 days (replay capability)                                       â”‚   â”‚
â”‚  â”‚  Throughput: 50,000 events/sec peak                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                                   â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚         â”‚                        â”‚                        â”‚                         â”‚
â”‚         â–¼                        â–¼                        â–¼                         â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                â”‚
â”‚  â•‘  REAL-TIME       â•‘   â•‘  ANALYTICS       â•‘   â•‘  SECURITY        â•‘                â”‚
â”‚  â•‘  ALERTING        â•‘   â•‘  & BI            â•‘   â•‘  SIEM            â•‘                â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£                â”‚
â”‚  â•‘                  â•‘   â•‘                  â•‘   â•‘                  â•‘                â”‚
â”‚  â•‘  Stream Analyticsâ•‘   â•‘  Synapse/        â•‘   â•‘  Azure Sentinel  â•‘                â”‚
â”‚  â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘   â•‘  Databricks      â•‘   â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘                â”‚
â”‚  â•‘                  â•‘   â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘   â•‘                  â•‘                â”‚
â”‚  â•‘  Anomaly Rules:  â•‘   â•‘                  â•‘   â•‘  Correlate with: â•‘                â”‚
â”‚  â•‘  â€¢ Mass delete   â•‘   â•‘  Use Cases:      â•‘   â•‘  â€¢ Login events  â•‘                â”‚
â”‚  â•‘    (>100/min by  â•‘   â•‘  â€¢ User behavior â•‘   â•‘  â€¢ Network logs  â•‘                â”‚
â”‚  â•‘     same user)   â•‘   â•‘    analysis      â•‘   â•‘  â€¢ WAF alerts    â•‘                â”‚
â”‚  â•‘  â€¢ After-hours   â•‘   â•‘  â€¢ System usage  â•‘   â•‘                  â•‘                â”‚
â”‚  â•‘    sensitive ops â•‘   â•‘    trends        â•‘   â•‘  Detect:         â•‘                â”‚
â”‚  â•‘  â€¢ Unusual       â•‘   â•‘  â€¢ Compliance    â•‘   â•‘  â€¢ Data exfil    â•‘                â”‚
â”‚  â•‘    access patternâ•‘   â•‘    dashboards    â•‘   â•‘  â€¢ Insider threatâ•‘                â”‚
â”‚  â•‘                  â•‘   â•‘  â€¢ Audit metrics â•‘   â•‘  â€¢ Account takeover              â•‘
â”‚  â•šâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•   â•šâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•   â•šâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•                â”‚
â”‚           â”‚                      â”‚                      â”‚                          â”‚
â”‚           â–¼                      â–¼                      â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Alert Actions   â”‚   â”‚  Power BI        â”‚   â”‚  Security        â”‚                â”‚
â”‚  â”‚  â€¢ PagerDuty     â”‚   â”‚  Dashboards      â”‚   â”‚  Incident        â”‚                â”‚
â”‚  â”‚  â€¢ Teams/Slack   â”‚   â”‚  â€¢ Exec summary  â”‚   â”‚  Response        â”‚                â”‚
â”‚  â”‚  â€¢ Email         â”‚   â”‚  â€¢ Ops metrics   â”‚   â”‚  Playbooks       â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Anomaly Detection Rules (å¼‚å¸¸æ£€æµ‹è§„åˆ™)

| Rule Name | Pattern | Threshold | Alert | Response |
|-----------|---------|-----------|-------|----------|
| **MassDelete** | Same user deletes many records | >100 deletes/5min | ğŸ”´ Critical | Auto-suspend user, notify SOC |
| **AfterHoursAccess** | Sensitive entity access outside business hours | Any access 22:00-06:00 | ğŸŸ¡ Warning | Log for review |
| **UnusualGeoAccess** | Access from new geographic location | New country/region | ğŸŸ¡ Warning | MFA challenge |
| **PrivilegeEscalation** | Permission changes on admin accounts | Any change | ğŸ”´ Critical | Require approval |
| **DataExport** | Large data exports | >10,000 records exported | ğŸŸ¡ Warning | Log, notify manager |
| **FailedAccessSpike** | Multiple failed access attempts | >10 failures/min | ğŸŸ¡ Warning | Temp block IP |

### Knowledge Graph for Investigation (è°ƒæŸ¥çŸ¥è¯†å›¾è°±)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUDIT KNOWLEDGE GRAPH (å®¡è®¡çŸ¥è¯†å›¾è°±)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  Use Case: "Why was Order #12345 delivered late?"                                   â”‚
â”‚                                                                                      â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚                            â”‚   User:     â”‚                                          â”‚
â”‚                            â”‚   æç»ç†    â”‚                                          â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                   â”‚ modified                                        â”‚
â”‚                                   â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Carrier:  â”‚â—€â”€â”€â”€â”‚        Order #12345           â”‚â”€â”€â”€â–¶â”‚  Shipment:    â”‚           â”‚
â”‚  â”‚ SF Expressâ”‚    â”‚                               â”‚    â”‚  SHP-789      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  Created: 2026-01-30 10:00    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â”‚           â”‚  Status changes: 5            â”‚            â”‚                    â”‚
â”‚       â”‚           â”‚  Address modified: 2x         â”‚            â”‚                    â”‚
â”‚       â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                    â”‚
â”‚       â”‚                         â”‚                              â”‚                    â”‚
â”‚       â”‚                         â”‚ caused                       â”‚                    â”‚
â”‚       â–¼                         â–¼                              â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ API Call  â”‚    â”‚     Address Change Event      â”‚    â”‚ Route Recalc  â”‚           â”‚
â”‚  â”‚ (booking) â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ (delayed 2hr) â”‚           â”‚
â”‚  â”‚ @14:00    â”‚    â”‚  Old: åŒ—äº¬å¸‚æœé˜³åŒºxxx         â”‚    â”‚               â”‚           â”‚
â”‚  â”‚           â”‚    â”‚  New: åŒ—äº¬å¸‚æµ·æ·€åŒºyyy         â”‚    â”‚               â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  By: æç»ç† @15:00            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                   â”‚  âš ï¸ After dispatch!           â”‚                                â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                                      â”‚
â”‚  Investigation Result:                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚  Root Cause: Address changed AFTER carrier booked, causing route recalculation      â”‚
â”‚  Impact: 2-hour delivery delay                                                      â”‚
â”‚  Recommendation: Add guard to prevent address change after dispatch                 â”‚
â”‚                                                                                      â”‚
â”‚  Graph Query (Gremlin/Cypher):                                                      â”‚
â”‚  g.V('Order#12345').outE('modified_by','caused','shipped_by').inV().path()         â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ System Resilience & Deployment

### High Availability Architecture (é«˜å¯ç”¨æ¶æ„)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HIGH AVAILABILITY DEPLOYMENT                                      â”‚
â”‚                    é«˜å¯ç”¨éƒ¨ç½²æ¶æ„                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚                              AZURE REGION: China East                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚   Availability Zone 1           Availability Zone 2           Zone 3        â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚   â”‚ Audit Service    â”‚         â”‚ Audit Service    â”‚         â”‚ Audit     â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ Instance 1       â”‚         â”‚ Instance 2       â”‚         â”‚ Service   â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚         â”‚ Instance 3â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ â€¢ Channel Queue  â”‚         â”‚ â€¢ Channel Queue  â”‚         â”‚           â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ â€¢ Object Pool    â”‚         â”‚ â€¢ Object Pool    â”‚         â”‚           â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚            â”‚                            â”‚                         â”‚         â”‚   â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚  â”‚                                         â”‚                                    â”‚   â”‚
â”‚  â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â”‚
â”‚  â”‚                            â”‚    Azure Load Balancer  â”‚                      â”‚   â”‚
â”‚  â”‚                            â”‚    (health checks)      â”‚                      â”‚   â”‚
â”‚  â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   â”‚
â”‚  â”‚                                         â”‚                                    â”‚   â”‚
â”‚  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚            â”‚                            â”‚                            â”‚      â”‚   â”‚
â”‚  â”‚            â–¼                            â–¼                            â–¼      â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚   â”‚ SQL Server       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ SQL Server       â”‚         â”‚ SQL Serverâ”‚   â”‚   â”‚
â”‚  â”‚   â”‚ Primary          â”‚  sync   â”‚ Secondary        â”‚  async  â”‚ Read      â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ (Zone 1)         â”‚  repl   â”‚ (Zone 2)         â”‚  repl   â”‚ Replica   â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚   â”‚                    Event Hubs (Multi-Zone)                            â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   Partition 0   Partition 1   ...   Partition 15                     â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   (Zone 1)      (Zone 2)            (Zone 3)                         â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                           â”‚
â”‚                                         â”‚ Geo-replication                           â”‚
â”‚                                         â–¼                                           â”‚
â”‚                              AZURE REGION: China North (DR)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   â€¢ Standby SQL replicas (async replication, RPO < 5 min)                    â”‚   â”‚
â”‚  â”‚   â€¢ Standby Audit Service instances (cold standby)                           â”‚   â”‚
â”‚  â”‚   â€¢ Blob storage geo-redundant (GRS)                                         â”‚   â”‚
â”‚  â”‚   â€¢ RTO: < 1 hour for full failover                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Tamper-Proofing (æ•°æ®é˜²ç¯¡æ”¹)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA INTEGRITY & TAMPER-PROOFING                                  â”‚
â”‚                    æ•°æ®å®Œæ•´æ€§ä¸é˜²ç¯¡æ”¹                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         HASH CHAIN (å“ˆå¸Œé“¾)                                   â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚   Record 1          Record 2          Record 3          Record 4            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚ Data    â”‚       â”‚ Data    â”‚       â”‚ Data    â”‚       â”‚ Data    â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€ â”‚       â”‚ â”€â”€â”€â”€â”€â”€â”€ â”‚       â”‚ â”€â”€â”€â”€â”€â”€â”€ â”‚       â”‚ â”€â”€â”€â”€â”€â”€â”€ â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ PrevHashâ”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ PrevHashâ”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ PrevHashâ”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ PrevHashâ”‚          â”‚   â”‚
â”‚  â”‚  â”‚ = 0x000 â”‚       â”‚ = H(R1) â”‚       â”‚ = H(R2) â”‚       â”‚ = H(R3) â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ Hash    â”‚       â”‚ Hash    â”‚       â”‚ Hash    â”‚       â”‚ Hash    â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ = H(R1) â”‚       â”‚ = H(R2) â”‚       â”‚ = H(R3) â”‚       â”‚ = H(R4) â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  If any record modified â†’ hash chain breaks â†’ tamper detected!               â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         DAILY CHECKPOINT TO BLOCKCHAIN                        â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚   Daily Batch                                                                â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚   â”‚
â”‚  â”‚   â”‚ Date: 2026-02-01                    â”‚                                    â”‚   â”‚
â”‚  â”‚   â”‚ Records: 2,500,000                  â”‚                                    â”‚   â”‚
â”‚  â”‚   â”‚ Merkle Root: 0x7a8b9c...           â”‚                                    â”‚   â”‚
â”‚  â”‚   â”‚ Previous Day Hash: 0x4d5e6f...     â”‚                                    â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚   â”‚
â”‚  â”‚                    â”‚                                                         â”‚   â”‚
â”‚  â”‚                    â”‚ Submit checkpoint                                       â”‚   â”‚
â”‚  â”‚                    â–¼                                                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚   â”‚
â”‚  â”‚   â”‚     Immutable Ledger Options        â”‚                                    â”‚   â”‚
â”‚  â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                                    â”‚   â”‚
â”‚  â”‚   â”‚  â€¢ Azure Confidential Ledger        â”‚ â† Recommended for enterprise      â”‚   â”‚
â”‚  â”‚   â”‚  â€¢ Azure Immutable Blob (WORM)      â”‚ â† Cost-effective                  â”‚   â”‚
â”‚  â”‚   â”‚  â€¢ Hyperledger (private blockchain) â”‚ â† Maximum trust                   â”‚   â”‚
â”‚  â”‚   â”‚  â€¢ Public blockchain (Ethereum)     â”‚ â† Regulatory requirement          â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  Verification Process:                                                       â”‚   â”‚
â”‚  â”‚  1. Rebuild Merkle tree from audit records                                   â”‚   â”‚
â”‚  â”‚  2. Compare root hash with blockchain checkpoint                             â”‚   â”‚
â”‚  â”‚  3. If match â†’ data integrity confirmed                                      â”‚   â”‚
â”‚  â”‚  4. If mismatch â†’ identify tampered records via Merkle proof                 â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â”‚  Compliance Proof Generation:                                                        â”‚
â”‚  â€¢ "Prove Order #12345 audit trail has not been modified"                          â”‚
â”‚  â€¢ Generate Merkle proof from record to blockchain checkpoint                       â”‚
â”‚  â€¢ Auditor can independently verify against public ledger                           â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Disaster Recovery Plan (ç¾éš¾æ¢å¤è®¡åˆ’)

| Scenario | RTO | RPO | Recovery Steps |
|----------|-----|-----|----------------|
| **Single AZ failure** | 0 (auto-failover) | 0 | Load balancer routes to healthy AZ |
| **Database failure** | < 5 min | 0 | Automatic failover to secondary |
| **Region failure** | < 1 hour | < 5 min | Manual failover to DR region |
| **Ransomware attack** | < 4 hours | < 1 hour | Restore from immutable backups |
| **Data corruption** | < 2 hours | Point-in-time | PITR from transaction logs |

---

## ï¿½ğŸ“‹ Compliance Requirements

### ISO 27001 Mapping

| Control | Requirement | Implementation |
|---------|-------------|----------------|
| A.12.4.1 | Event logging | AuditInterceptor captures all changes |
| A.12.4.2 | Protection of log information | Append-only, role-based access |
| A.12.4.3 | Admin and operator logs | Separate security audit category |
| A.12.4.4 | Clock synchronization | All timestamps in UTC |

### GDPR Mapping

| Requirement | Implementation |
|-------------|----------------|
| Right to access | Query API returns user's audit trail |
| Right to erasure | Audit of deletion, not actual deletion |
| Data minimization | Only necessary fields logged |
| Purpose limitation | Audit categories enforce purpose |
| Data retention | Category-based retention policies |

### Report Types

| Report | Content | Format | Schedule |
|--------|---------|--------|----------|
| Access Report | Who accessed what data | PDF/Excel | On-demand |
| Change Report | All modifications in period | PDF/Excel | Weekly |
| Security Report | Login attempts, permission changes | PDF | Daily |
| Compliance Summary | Aggregated metrics | PDF | Monthly |
| Data Export Log | All exports performed | PDF | On-demand |

---

## ğŸ”Œ Integration Points

### Upstream Dependencies (Audits)

| System | Events Captured | Audit Category |
|--------|-----------------|----------------|
| Dynamic Routing (01) | Route calculations, selections | BusinessAction |
| Multi-Carrier (02) | Carrier bookings, cancellations | BusinessAction, ApiCall |
| Real-time Tracking (03) | Status changes, location updates | DataChange |
| Order Processing (04) | All order state changes | DataChange, BusinessAction |

### Downstream Consumers

| System | Data Consumed | Integration |
|--------|---------------|-------------|
| Compliance Dashboard | Aggregated metrics | Query API |
| SIEM System | Security events | Event stream |
| Analytics Platform | Business events | Export/Stream |
| Support Tools | Investigation data | Query API |

### Event Integration

```
All Domain Events â†’ Audit Service

OrderCreated Event:
  â””â”€â–¶ AuditService.LogBusinessAction("OrderCreated", orderId, details)

CarrierBooked Event:
  â””â”€â–¶ AuditService.LogBusinessAction("CarrierBooked", shipmentId, carrierDetails)
  â””â”€â–¶ AuditService.LogExternalApiCall("SFExpress", "/book", request, response)

TrackingUpdated Event:
  â””â”€â–¶ AuditService.LogEntityChange("Shipment", shipmentId, oldStatus, newStatus)
```

---

## ï¿½ Design Pattern Ledger

### Patterns Used in Audit Domain (æœ¬åŸŸè®¾è®¡æ¨¡å¼ç™»è®°ç°¿)

| Pattern | Location | Purpose | Study Guide |
|---------|----------|---------|-------------|
| **Interceptor Pattern** (æ‹¦æˆªå™¨æ¨¡å¼) | EF Core SaveChanges | Transparently capture all entity changes | [INTERCEPTOR-PATTERN.md](../design-patterns/INTERCEPTOR-PATTERN.md) |
| **Decorator Pattern** (è£…é¥°å™¨æ¨¡å¼) | PII masking, hashing | Layer processing responsibilities | [DECORATOR-PATTERN.md](../design-patterns/DECORATOR-PATTERN.md) |
| **Strategy Pattern** (ç­–ç•¥æ¨¡å¼) | Storage selection | Different storage backends per scenario | [STRATEGY-PATTERN.md](../design-patterns/STRATEGY-PATTERN.md) |
| **Chain of Responsibility** (è´£ä»»é“¾æ¨¡å¼) | PII discovery | Extensible sensitive data detection | Refactoring Guru |
| **Observer Pattern** (è§‚å¯Ÿè€…æ¨¡å¼) | Event streaming | Notify downstream consumers | [OBSERVER-PATTERN.md](../design-patterns/OBSERVER-PATTERN.md) |
| **Object Pool** (å¯¹è±¡æ± æ¨¡å¼) | AuditEntry reuse | Reduce GC pressure in high-throughput | Microsoft docs |
| **Producer-Consumer** (ç”Ÿäº§è€…-æ¶ˆè´¹è€…) | Channel queue | Async non-blocking audit writes | .NET docs |
| **Event Sourcing** (äº‹ä»¶æº¯æº) | Audit history | Complete immutable event log | Microsoft docs |

### Pattern Decision Matrix (æ¨¡å¼é€‰å‹å†³ç­–çŸ©é˜µ)

| Problem | Considered Patterns | Chosen | Reason |
|---------|---------------------|--------|--------|
| Capture DB changes | Triggers vs Interceptor | **Interceptor** | Database-agnostic, testable |
| PII handling | Filter vs Decorator | **Decorator** | Composable, single responsibility |
| Storage flexibility | Factory vs Strategy | **Strategy** | Runtime selection based on context |
| High throughput | Sync vs Async | **Channel + Object Pool** | Non-blocking, memory efficient |
| Data tamper-proof | Signing vs Hash Chain | **Hash Chain + Blockchain** | Industry standard for audit |

---

## ğŸ—ºï¸ Implementation Roadmap

### Phase Overview (é˜¶æ®µæ¦‚è§ˆ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUDIT SYSTEM IMPLEMENTATION ROADMAP                               â”‚
â”‚                    å®¡è®¡ç³»ç»Ÿå®æ–½è·¯çº¿å›¾                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  PHASE 1: CORE FOUNDATION (æ ¸å¿ƒè½åœ°)                           4-6 weeks      â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  Deliverables:                                                                â•‘  â”‚
â”‚  â•‘  âœ… AuditInterceptor implementation (synchronous)                             â•‘  â”‚
â”‚  â•‘  âœ… Basic AuditLog table schema                                               â•‘  â”‚
â”‚  â•‘  âœ… IAuditableEntity marker interface                                         â•‘  â”‚
â”‚  â•‘  âœ… User context capture via HttpContext                                      â•‘  â”‚
â”‚  â•‘  âœ… Basic Query API (by entity, date, user)                                   â•‘  â”‚
â”‚  â•‘  âœ… Simple PII masking (attribute-based)                                      â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  Success Criteria:                                                            â•‘  â”‚
â”‚  â•‘  â€¢ All entity changes logged with <50ms overhead                              â•‘  â”‚
â”‚  â•‘  â€¢ Query API returns results in <500ms                                        â•‘  â”‚
â”‚  â•‘  â€¢ Basic compliance report generation                                         â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                         â”‚                                           â”‚
â”‚                                         â–¼                                           â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  PHASE 2: PERFORMANCE & RELIABILITY (å¢å¼ºå¯é )                 6-8 weeks      â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  Deliverables:                                                                â•‘  â”‚
â”‚  â•‘  âœ… Async Channel queue for non-blocking writes                               â•‘  â”‚
â”‚  â•‘  âœ… Object pooling for AuditEntry                                             â•‘  â”‚
â”‚  â•‘  âœ… Batch insert optimization                                                 â•‘  â”‚
â”‚  â•‘  âœ… Tiered storage (Hot â†’ Warm archival)                                      â•‘  â”‚
â”‚  â•‘  âœ… Decorator pattern for PII masking chain                                   â•‘  â”‚
â”‚  â•‘  âœ… Basic observability metrics (Prometheus)                                  â•‘  â”‚
â”‚  â•‘  âœ… Retention policy enforcement                                              â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  Success Criteria:                                                            â•‘  â”‚
â”‚  â•‘  â€¢ Main transaction overhead <5ms (async)                                     â•‘  â”‚
â”‚  â•‘  â€¢ Handle 10,000 events/sec sustained                                         â•‘  â”‚
â”‚  â•‘  â€¢ Storage costs reduced 60% with tiering                                     â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                         â”‚                                           â”‚
â”‚                                         â–¼                                           â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  PHASE 3: VALUE EXTRACTION (ä»·å€¼æŒ–æ˜)                          8-10 weeks     â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  Deliverables:                                                                â•‘  â”‚
â”‚  â•‘  âœ… Event Hub/Kafka integration for streaming                                 â•‘  â”‚
â”‚  â•‘  âœ… Real-time anomaly detection (Stream Analytics)                            â•‘  â”‚
â”‚  â•‘  âœ… SIEM integration (Azure Sentinel)                                         â•‘  â”‚
â”‚  â•‘  âœ… Analytics dashboards (Power BI)                                           â•‘  â”‚
â”‚  â•‘  âœ… Knowledge graph for investigation                                         â•‘  â”‚
â”‚  â•‘  âœ… Elasticsearch integration for complex queries                             â•‘  â”‚
â”‚  â•‘  âœ… Alert rules and automated responses                                       â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  Success Criteria:                                                            â•‘  â”‚
â”‚  â•‘  â€¢ Anomaly detection within 1 minute of event                                 â•‘  â”‚
â”‚  â•‘  â€¢ Investigation time reduced 70%                                             â•‘  â”‚
â”‚  â•‘  â€¢ Audit data actively used for business insights                             â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                         â”‚                                           â”‚
â”‚                                         â–¼                                           â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  PHASE 4: ENTERPRISE HARDENING (ä¼ä¸šåŠ å›º)                      6-8 weeks      â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  Deliverables:                                                                â•‘  â”‚
â”‚  â•‘  âœ… Hash chain implementation for tamper-proofing                             â•‘  â”‚
â”‚  â•‘  âœ… Blockchain/immutable ledger integration                                   â•‘  â”‚
â”‚  â•‘  âœ… Multi-region deployment with DR                                           â•‘  â”‚
â”‚  â•‘  âœ… GDPR right-to-erasure automation                                          â•‘  â”‚
â”‚  â•‘  âœ… Cold storage (Azure Archive/Glacier)                                      â•‘  â”‚
â”‚  â•‘  âœ… Compliance certification preparation (ISO 27001)                          â•‘  â”‚
â”‚  â•‘  âœ… Penetration testing and security audit                                    â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘  Success Criteria:                                                            â•‘  â”‚
â”‚  â•‘  â€¢ Data integrity cryptographically provable                                  â•‘  â”‚
â”‚  â•‘  â€¢ RTO < 1 hour for regional failover                                         â•‘  â”‚
â”‚  â•‘  â€¢ Pass ISO 27001 audit                                                       â•‘  â”‚
â”‚  â•‘  â€¢ GDPR erasure requests processed in <72 hours                               â•‘  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                                      â”‚
â”‚  Total Timeline: 24-32 weeks                                                        â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase Dependencies (é˜¶æ®µä¾èµ–)

```
           Phase 1                    Phase 2                    Phase 3                    Phase 4
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Core Foundation    â”‚â”€â”€â”€â”€â–¶â”‚ Performance        â”‚â”€â”€â”€â”€â–¶â”‚ Value Extraction   â”‚â”€â”€â”€â”€â–¶â”‚ Enterprise         â”‚
    â”‚                    â”‚     â”‚                    â”‚     â”‚                    â”‚     â”‚ Hardening          â”‚
    â”‚ â€¢ Interceptor      â”‚     â”‚ â€¢ Async queue      â”‚     â”‚ â€¢ Event streaming  â”‚     â”‚ â€¢ Hash chain       â”‚
    â”‚ â€¢ Basic storage    â”‚     â”‚ â€¢ Tiered storage   â”‚     â”‚ â€¢ Anomaly detect   â”‚     â”‚ â€¢ Blockchain       â”‚
    â”‚ â€¢ Query API        â”‚     â”‚ â€¢ Observability    â”‚     â”‚ â€¢ Analytics        â”‚     â”‚ â€¢ Multi-region     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                          â”‚                          â”‚                          â”‚
           â”‚                          â”‚                          â”‚                          â”‚
           â–¼                          â–¼                          â–¼                          â–¼
    Meets basic compliance     Production-ready           Data-driven insights      Audit certification
    requirements               performance                enabled                   ready
```

---

## ï¿½ğŸ“š Study Resources

### Chinese Tech Community References

| Source | Search Keywords | Focus |
|--------|-----------------|-------|
| CSDN | `ç‰©æµæ“ä½œæ—¥å¿— å®¡è®¡ EF Core` | EF Core audit implementation |
| CSDN | `ISO 27001 å®¡è®¡æ—¥å¿—` | Compliance logging |
| CSDN | `EF Coreæ‹¦æˆªå™¨ å®¡è®¡` | Interceptor pattern |
| CSDN | `é¡ºä¸°ç‰©æµå®¡è®¡å®ç°` | Industry reference |
| åšå®¢å›­ | `æ“ä½œæ—¥å¿— æœ€ä½³å®è·µ` | Best practices |

### EF Core References

| Resource | Content |
|----------|---------|
| Microsoft Docs | EF Core Interceptors |
| EF Core GitHub | SaveChangesInterceptor samples |
| ABP Framework | Audit logging module |

### Compliance References

| Resource | Content |
|----------|---------|
| ISO 27001 | Information security standard |
| GDPR Guidelines | Data protection requirements |
| ç½‘ç»œå®‰å…¨æ³• | China cybersecurity law |

---

## âœ… Acceptance Criteria

### Functional Acceptance

| ID | Criteria | Test Method |
|----|----------|-------------|
| AC-AU-001 | Entity create is logged automatically | Integration test |
| AC-AU-002 | Entity update captures old/new values | Unit test |
| AC-AU-003 | Entity delete is logged | Integration test |
| AC-AU-004 | User context is captured correctly | Unit test |
| AC-AU-005 | Correlation ID links related changes | Integration test |
| AC-AU-006 | PII is masked in logs | Unit test |
| AC-AU-007 | Can query logs by entity | API test |
| AC-AU-008 | Can query logs by date range | API test |
| AC-AU-009 | Can generate compliance report | Integration test |
| AC-AU-010 | Retention policy deletes old logs | Scheduled test |

### Non-Functional Acceptance

| ID | Criteria | Target | Test Method |
|----|----------|--------|-------------|
| NFR-AU-001 | Audit write latency | < 50ms | Performance |
| NFR-AU-002 | Audit query latency | < 500ms | Performance |
| NFR-AU-003 | Audit storage overhead | < 20% of data | Monitoring |
| NFR-AU-004 | Audit availability | 99.9% | Monitoring |
| NFR-AU-005 | Report generation time | < 30s | Performance |

---

## ğŸ”— Related Documents

- **Audits**: [01-DYNAMIC-ROUTING.md](01-DYNAMIC-ROUTING.md) - Route decisions
- **Audits**: [02-MULTI-CARRIER.md](02-MULTI-CARRIER.md) - Carrier interactions
- **Audits**: [03-REALTIME-TRACKING.md](03-REALTIME-TRACKING.md) - Status changes
- **Audits**: [04-ORDER-PROCESSING.md](04-ORDER-PROCESSING.md) - Order lifecycle
- **Pattern Guide**: [INTERCEPTOR-PATTERN.md](../design-patterns/INTERCEPTOR-PATTERN.md) - Primary pattern
- **Pattern Guide**: [DECORATOR-PATTERN.md](../design-patterns/DECORATOR-PATTERN.md) - PII masking
- **Index**: [00-INDEX.md](../00-INDEX.md)

---
*Enhanced: Observability, pattern integration, lifecycle management, data pipelines, resilience architecture, implementation roadmap*