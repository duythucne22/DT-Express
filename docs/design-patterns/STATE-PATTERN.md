# ğŸ”„ State Pattern Study Guide (çŠ¶æ€æ¨¡å¼å­¦ä¹ æŒ‡å—)

> **Status**: ğŸ“š Study Document  
> **Pattern Type**: Behavioral Design Pattern  
> **Primary Application**: Order Lifecycle Management (è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†)  
> **Related Domain**: [04-ORDER-PROCESSING.md](../core-domains/04-ORDER-PROCESSING.md)

---

## ğŸ“– Table of Contents

1. [Pattern Overview](#-pattern-overview)
2. [Problem It Solves](#-problem-it-solves)
3. [Pattern Structure](#-pattern-structure)
4. [Logistics Application](#-logistics-application)
5. [State vs Strategy Pattern](#-state-vs-strategy-pattern)
6. [Implementation Variations](#-implementation-variations)
7. [Anti-Patterns to Avoid](#-anti-patterns-to-avoid)
8. [Advanced Topics](#-advanced-topics)
9. [Chinese Tech References](#-chinese-tech-references)
10. [Self-Assessment](#-self-assessment)

---

## ğŸ¯ Pattern Overview

### Definition (å®šä¹‰)

> **State Pattern** allows an object to alter its behavior when its internal state changes. The object will appear to change its class.
>
> **çŠ¶æ€æ¨¡å¼**å…è®¸å¯¹è±¡åœ¨å†…éƒ¨çŠ¶æ€æ”¹å˜æ—¶æ”¹å˜å®ƒçš„è¡Œä¸ºã€‚å¯¹è±¡çœ‹èµ·æ¥å¥½åƒä¿®æ”¹äº†å®ƒçš„ç±»ã€‚

### Visual Metaphor: Traffic Light (çº¢ç»¿ç¯æ¯”å–»)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         THE TRAFFIC LIGHT ANALOGY                           â”‚
â”‚                         çº¢ç»¿ç¯çš„æ¯”å–»                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  A traffic light behaves differently based on its current state:            â”‚
â”‚  çº¢ç»¿ç¯æ ¹æ®å½“å‰çŠ¶æ€æœ‰ä¸åŒçš„è¡Œä¸º                                                â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚       ğŸ”´ RED STATE                                              â”‚       â”‚
â”‚  â”‚       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚        â”‚
â”‚  â”‚       â€¢ Vehicles STOP (è½¦è¾†åœæ­¢)                                 â”‚        â”‚
â”‚  â”‚       â€¢ Pedestrians can CROSS (è¡Œäººå¯é€šè¡Œ)                       â”‚        â”‚
â”‚  â”‚       â€¢ Duration: 30 seconds                                    â”‚        â”‚
â”‚  â”‚       â€¢ Next state: GREEN                                       â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚              â”‚ timer expires                                    â”‚        â”‚
â”‚  â”‚              â–¼                                                  â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚       ğŸŸ¢ GREEN STATE                                            â”‚        â”‚
â”‚  â”‚       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚        â”‚
â”‚  â”‚       â€¢ Vehicles GO (è½¦è¾†é€šè¡Œ)                                   â”‚        â”‚
â”‚  â”‚       â€¢ Pedestrians WAIT (è¡Œäººç­‰å¾…)                              â”‚        â”‚
â”‚  â”‚       â€¢ Duration: 45 seconds                                    â”‚        â”‚
â”‚  â”‚       â€¢ Next state: YELLOW                                      â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚              â”‚ timer expires                                    â”‚        â”‚
â”‚  â”‚              â–¼                                                  â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚       ğŸŸ¡ YELLOW STATE                                           â”‚        â”‚
â”‚  â”‚       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚        â”‚
â”‚  â”‚       â€¢ Vehicles SLOW DOWN (è½¦è¾†å‡é€Ÿ)                            â”‚        â”‚
â”‚  â”‚       â€¢ Pedestrians PREPARE (è¡Œäººå‡†å¤‡)                           â”‚        â”‚
â”‚  â”‚       â€¢ Duration: 5 seconds                                     â”‚        â”‚
â”‚  â”‚       â€¢ Next state: RED                                         â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â”‚  KEY INSIGHT:                                                               â”‚
â”‚  â€¢ Same traffic light, different behaviors                                  â”‚
â”‚  â€¢ Each state knows what it can do and what comes next                      â”‚
â”‚  â€¢ Invalid transitions prevented (can't go RED â†’ YELLOW directly)           â”‚
â”‚                                                                             â”‚
â”‚  In Order Processing:                                                       â”‚
â”‚  â€¢ Same Order object, different allowed operations                          â”‚
â”‚  â€¢ CREATED state allows cancel, DELIVERED state does not                    â”‚
â”‚  â€¢ Each state enforces valid transitions                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pattern Components (æ¨¡å¼ç»„ä»¶)

| Component | Role | Order Processing Example |
|-----------|------|--------------------------|
| **Context** | Maintains current state, delegates | `Order` (maintains `IOrderState`) |
| **State Interface** | Defines state-specific behavior | `IOrderState` |
| **Concrete States** | Implement behavior for each state | `CreatedState`, `DispatchedState`, `DeliveredState` |
| **Transition** | Change from one state to another | `Order.TransitionTo(newState)` |

---

## ğŸ”¥ Problem It Solves

### The Anti-Pattern (Without State Pattern)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    âŒ ANTI-PATTERN: GIANT SWITCH STATEMENT                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  public class Order                                                         â”‚
â”‚  {                                                                          â”‚
â”‚      public OrderStatus Status { get; set; }                                â”‚
â”‚                                                                             â”‚
â”‚      public void Cancel()                                                   â”‚
â”‚      {                                                                      â”‚
â”‚          switch (Status)                                                    â”‚
â”‚          {                                                                  â”‚
â”‚              case OrderStatus.CREATED:                                      â”‚
â”‚                  // 50 lines: Cancel logic for created orders               â”‚
â”‚                  Status = OrderStatus.CANCELLED;                            â”‚
â”‚                  break;                                                     â”‚
â”‚                                                                             â”‚
â”‚              case OrderStatus.CONFIRMED:                                    â”‚
â”‚                  // 75 lines: Cancel logic for confirmed orders             â”‚
â”‚                  // Need to refund payment                                  â”‚
â”‚                  Status = OrderStatus.CANCELLED;                            â”‚
â”‚                  break;                                                     â”‚
â”‚                                                                             â”‚
â”‚              case OrderStatus.DISPATCHED:                                   â”‚
â”‚                  // 100 lines: Cancel logic for dispatched orders           â”‚
â”‚                  // Need to cancel with carrier                             â”‚
â”‚                  // Need to refund payment                                  â”‚
â”‚                  Status = OrderStatus.CANCELLED;                            â”‚
â”‚                  break;                                                     â”‚
â”‚                                                                             â”‚
â”‚              case OrderStatus.IN_TRANSIT:                                   â”‚
â”‚                  throw new InvalidOperationException("Cannot cancel");      â”‚
â”‚                                                                             â”‚
â”‚              case OrderStatus.DELIVERED:                                    â”‚
â”‚                  throw new InvalidOperationException("Cannot cancel");      â”‚
â”‚                                                                             â”‚
â”‚              // ... more cases for each status                              â”‚
â”‚          }                                                                  â”‚
â”‚      }                                                                      â”‚
â”‚                                                                             â”‚
â”‚      public void Ship()                                                     â”‚
â”‚      {                                                                      â”‚
â”‚          switch (Status)  // Another giant switch!                          â”‚
â”‚          {                                                                  â”‚
â”‚              // ... similar explosion of cases                              â”‚
â”‚          }                                                                  â”‚
â”‚      }                                                                      â”‚
â”‚                                                                             â”‚
â”‚      public void Deliver()                                                  â”‚
â”‚      {                                                                      â”‚
â”‚          switch (Status)  // Yet another giant switch!                      â”‚
â”‚          {                                                                  â”‚
â”‚              // ... and again                                               â”‚
â”‚          }                                                                  â”‚
â”‚      }                                                                      â”‚
â”‚  }                                                                          â”‚
â”‚                                                                             â”‚
â”‚  PROBLEMS:                                                                  â”‚
â”‚  âŒ Order class grows to 1000+ lines                                        â”‚
â”‚  âŒ Adding new status requires editing ALL methods                          â”‚
â”‚  âŒ Easy to forget a case in one of the switches                            â”‚
â”‚  âŒ Business rules for each state scattered across methods                  â”‚
â”‚  âŒ Testing requires testing all combinations                               â”‚
â”‚  âŒ Violates Open/Closed Principle                                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Real-World Pain Point (çœŸå®ç—›ç‚¹)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº¬ä¸œç‰©æµè®¢å•çŠ¶æ€ç®¡ç†æ¼”è¿› (JD Logistics Evolution)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Phase 1 (2010): Simple enum + switch                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â€¢ 5 statuses: CREATED, SHIPPED, DELIVERED, CANCELLED, EXCEPTION            â”‚
â”‚  â€¢ Switch statements manageable                                             â”‚
â”‚  â€¢ 1 developer could understand entire flow                                 â”‚
â”‚                                                                              â”‚
â”‚  Phase 2 (2015): Growth pain                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â€¢ 20+ statuses: Added warehouse states, carrier states, return states      â”‚
â”‚  â€¢ Switch statements became unmanageable                                    â”‚
â”‚  â€¢ Bugs: "Order cancelled but carrier not notified"                         â”‚
â”‚  â€¢ Each new status = 15 files to modify                                     â”‚
â”‚                                                                              â”‚
â”‚  Phase 3 (2018): State Pattern adoption                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â€¢ Each state in own class                                                  â”‚
â”‚  â€¢ Adding new state = adding new class (Open for extension)                 â”‚
â”‚  â€¢ Transitions explicit and testable                                        â”‚
â”‚  â€¢ é’é¾™ç³»ç»Ÿ (Qinglong) refactored to State Pattern                          â”‚
â”‚                                                                              â”‚
â”‚  Phase 4 (2023): State + Event Sourcing                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â€¢ All transitions recorded as events                                       â”‚
â”‚  â€¢ Complete audit trail                                                     â”‚
â”‚  â€¢ Ability to replay order history                                          â”‚
â”‚  â€¢ 50+ states managed cleanly                                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ Pattern Structure

### Class Diagram (ç±»å›¾)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STATE PATTERN STRUCTURE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         Order (Context)                              â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚
â”‚  â”‚  - _state: IOrderState                                              â”‚    â”‚
â”‚  â”‚  - Id: Guid                                                         â”‚    â”‚
â”‚  â”‚  - OrderNumber: string                                              â”‚    â”‚
â”‚  â”‚  - Customer: CustomerInfo                                           â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  + CurrentStatus: OrderStatus { get => _state.Status }              â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  + Confirm()          // Delegates to _state.Confirm(this)          â”‚    â”‚
â”‚  â”‚  + Dispatch()         // Delegates to _state.Dispatch(this)         â”‚    â”‚
â”‚  â”‚  + MarkInTransit()    // Delegates to _state.MarkInTransit(this)    â”‚    â”‚
â”‚  â”‚  + Deliver()          // Delegates to _state.Deliver(this)          â”‚    â”‚
â”‚  â”‚  + Cancel(reason)     // Delegates to _state.Cancel(this, reason)   â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  + TransitionTo(newState: IOrderState)  // Internal state change    â”‚    â”‚
â”‚  â”‚    {                                                                â”‚    â”‚
â”‚  â”‚        var oldState = _state;                                       â”‚    â”‚
â”‚  â”‚        _state = newState;                                           â”‚    â”‚
â”‚  â”‚        _state.OnEnter(this, oldState);                              â”‚    â”‚
â”‚  â”‚        RaiseEvent(new OrderStateChanged(oldState, newState));       â”‚    â”‚
â”‚  â”‚    }                                                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â”‚ uses                                    â”‚
â”‚                                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                 <<interface>> IOrderState                            â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚
â”‚  â”‚  + Status: OrderStatus { get; }                                     â”‚    â”‚
â”‚  â”‚  + CanCancel: bool { get; }                                         â”‚    â”‚
â”‚  â”‚  + CanModify: bool { get; }                                         â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  + Confirm(context: Order)                                          â”‚    â”‚
â”‚  â”‚  + Dispatch(context: Order)                                         â”‚    â”‚
â”‚  â”‚  + MarkInTransit(context: Order)                                    â”‚    â”‚
â”‚  â”‚  + Deliver(context: Order)                                          â”‚    â”‚
â”‚  â”‚  + Cancel(context: Order, reason: string)                           â”‚    â”‚
â”‚  â”‚  + OnEnter(context: Order, previousState: IOrderState)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                    â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚              â”‚           â”‚           â”‚              â”‚             â”‚
â”‚         â–¼              â–¼           â–¼           â–¼              â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Created   â”‚  â”‚ Confirmed â”‚ â”‚Dispatched â”‚ â”‚ InTransit â”‚ â”‚ Delivered â”‚    â”‚
â”‚  â”‚  State    â”‚  â”‚   State   â”‚ â”‚   State   â”‚ â”‚   State   â”‚ â”‚   State   â”‚    â”‚
â”‚  â”‚           â”‚  â”‚           â”‚ â”‚           â”‚ â”‚           â”‚ â”‚           â”‚    â”‚
â”‚  â”‚CanCancel  â”‚  â”‚CanCancel  â”‚ â”‚CanCancel  â”‚ â”‚CanCancel  â”‚ â”‚CanCancel  â”‚    â”‚
â”‚  â”‚  = true   â”‚  â”‚  = true   â”‚ â”‚  = true   â”‚ â”‚  = false  â”‚ â”‚  = false  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  Each concrete state:                                                        â”‚
â”‚  â€¢ Implements valid operations for that state                               â”‚
â”‚  â€¢ Throws InvalidStateTransitionException for invalid operations            â”‚
â”‚  â€¢ Knows which states it can transition to                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### State Transition Table (çŠ¶æ€è½¬æ¢è¡¨)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STATE TRANSITION TABLE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Current State  â”‚                    Actions                            â”‚ â”‚
â”‚  â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                â”‚ Confirm â”‚ Dispatchâ”‚ Deliver â”‚ Cancel  â”‚ RequestReturn â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ CREATED        â”‚ â†’ CONF  â”‚ âŒ      â”‚ âŒ      â”‚ â†’ CANC  â”‚ âŒ            â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ CONFIRMED      â”‚ âŒ      â”‚ â†’ DISP  â”‚ âŒ      â”‚ â†’ CANC  â”‚ âŒ            â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ DISPATCHED     â”‚ âŒ      â”‚ âŒ      â”‚ âŒ      â”‚ â†’ CANC* â”‚ âŒ            â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ IN_TRANSIT     â”‚ âŒ      â”‚ âŒ      â”‚ â†’ DELIV â”‚ âŒ      â”‚ âŒ            â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ DELIVERED      â”‚ âŒ      â”‚ âŒ      â”‚ âŒ      â”‚ âŒ      â”‚ â†’ RET_REQ     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ CANCELLED      â”‚ âŒ      â”‚ âŒ      â”‚ âŒ      â”‚ âŒ      â”‚ âŒ            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  Legend:                                                                     â”‚
â”‚  â†’ STATE = Transitions to that state                                        â”‚
â”‚  âŒ = Throws InvalidStateTransitionException                                â”‚
â”‚  * = Has additional business rules (e.g., must cancel with carrier)         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ Logistics Application

### Order State Machine (è®¢å•çŠ¶æ€æœº)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ORDER STATE MACHINE (è®¢å•çŠ¶æ€æœº)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                              â”‚ CREATED â”‚                                    â”‚
â”‚                              â”‚ å·²åˆ›å»º   â”‚                                    â”‚
â”‚                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                    â”‚
â”‚                     payment       â”‚      cancel                              â”‚
â”‚                     received      â”‚      requested                           â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                      â–¼                         â–¼                             â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                â”‚ CONFIRMED â”‚             â”‚ CANCELLED â”‚                      â”‚
â”‚                â”‚ å·²ç¡®è®¤     â”‚             â”‚ å·²å–æ¶ˆ     â”‚                      â”‚
â”‚                â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                      â”‚                         â–²                             â”‚
â”‚                      â”‚ carrier                 â”‚                             â”‚
â”‚                      â”‚ booked                  â”‚ cancel                      â”‚
â”‚                      â–¼                         â”‚ (before pickup)             â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚                             â”‚
â”‚                â”‚ DISPATCHED â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                â”‚ å·²å‘è´§      â”‚                                                â”‚
â”‚                â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                      â”‚ carrier                                               â”‚
â”‚                      â”‚ pickup                                                â”‚
â”‚                      â–¼                                                       â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚                â”‚ IN_TRANSIT â”‚                                                â”‚
â”‚                â”‚ è¿è¾“ä¸­      â”‚                                                â”‚
â”‚                â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                      â”‚ out for                                               â”‚
â”‚                      â”‚ delivery                                              â”‚
â”‚                      â–¼                                                       â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚           â”‚  OUT_FOR_DELIVERY    â”‚                                          â”‚
â”‚           â”‚  æ´¾é€ä¸­               â”‚                                          â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚             success  â”‚     failure                                           â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚             â–¼                 â–¼                                              â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚       â”‚ DELIVERED â”‚    â”‚ FAILED_DELIVERYâ”‚â—„â”€â”€â”                               â”‚
â”‚       â”‚ å·²ç­¾æ”¶     â”‚    â”‚ æ´¾é€å¤±è´¥        â”‚   â”‚ retry                         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                               â”‚
â”‚             â”‚                  â”‚            â”‚                                â”‚
â”‚             â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚             â”‚                                                                â”‚
â”‚             â”‚ customer                                                       â”‚
â”‚             â”‚ requests return                                                â”‚
â”‚             â–¼                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    REVERSE LOGISTICS FLOW (é€†å‘ç‰©æµ)                 â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚   â”‚ RETURN_REQUESTEDâ”‚ â”€â”€â–¶ â”‚ RETURN_IN_TRANSITâ”‚ â”€â”€â–¶â”‚RETURN_RECEIVEDâ”‚  â”‚    â”‚
â”‚  â”‚   â”‚ é€€è´§ç”³è¯·         â”‚     â”‚ é€€è´§è¿è¾“ä¸­        â”‚    â”‚ é€€è´§å·²ç­¾æ”¶    â”‚  â”‚    â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                                         â”‚          â”‚    â”‚
â”‚  â”‚                                                         â–¼          â”‚    â”‚
â”‚  â”‚                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚                                                  â”‚   REFUNDED   â”‚  â”‚    â”‚
â”‚  â”‚                                                  â”‚   å·²é€€æ¬¾      â”‚  â”‚    â”‚
â”‚  â”‚                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Concrete State Implementation Example

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONCRETE STATE: CreatedState                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  public class CreatedState : IOrderState                                     â”‚
â”‚  {                                                                           â”‚
â”‚      // Properties                                                           â”‚
â”‚      public OrderStatus Status => OrderStatus.CREATED;                       â”‚
â”‚      public bool CanCancel => true;    // âœ… Can cancel newly created order  â”‚
â”‚      public bool CanModify => true;    // âœ… Can modify address, items       â”‚
â”‚                                                                              â”‚
â”‚      // Allowed transitions                                                  â”‚
â”‚      public void Confirm(Order context)                                      â”‚
â”‚      {                                                                       â”‚
â”‚          // Business logic for confirmation                                  â”‚
â”‚          if (!context.HasValidPayment)                                       â”‚
â”‚              throw new OrderException("Payment required");                   â”‚
â”‚                                                                              â”‚
â”‚          context.ConfirmedAt = DateTime.UtcNow;                              â”‚
â”‚          context.TransitionTo(new ConfirmedState());                         â”‚
â”‚      }                                                                       â”‚
â”‚                                                                              â”‚
â”‚      public void Cancel(Order context, string reason)                        â”‚
â”‚      {                                                                       â”‚
â”‚          // Simple cancellation - no carrier to notify yet                   â”‚
â”‚          context.CancelledAt = DateTime.UtcNow;                              â”‚
â”‚          context.CancellationReason = reason;                                â”‚
â”‚          context.TransitionTo(new CancelledState());                         â”‚
â”‚      }                                                                       â”‚
â”‚                                                                              â”‚
â”‚      // Invalid transitions - throw exceptions                               â”‚
â”‚      public void Dispatch(Order context)                                     â”‚
â”‚          => throw new InvalidStateTransitionException(                       â”‚
â”‚              Status, OrderStatus.DISPATCHED, "Must confirm first");          â”‚
â”‚                                                                              â”‚
â”‚      public void MarkInTransit(Order context)                                â”‚
â”‚          => throw new InvalidStateTransitionException(                       â”‚
â”‚              Status, OrderStatus.IN_TRANSIT, "Must dispatch first");         â”‚
â”‚                                                                              â”‚
â”‚      public void Deliver(Order context)                                      â”‚
â”‚          => throw new InvalidStateTransitionException(                       â”‚
â”‚              Status, OrderStatus.DELIVERED, "Must be in transit first");     â”‚
â”‚                                                                              â”‚
â”‚      // Lifecycle hook                                                       â”‚
â”‚      public void OnEnter(Order context, IOrderState previousState)           â”‚
â”‚      {                                                                       â”‚
â”‚          // Called when entering this state                                  â”‚
â”‚          context.AddDomainEvent(new OrderCreatedEvent(context));             â”‚
â”‚      }                                                                       â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONCRETE STATE: InTransitState                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  public class InTransitState : IOrderState                                   â”‚
â”‚  {                                                                           â”‚
â”‚      public OrderStatus Status => OrderStatus.IN_TRANSIT;                    â”‚
â”‚      public bool CanCancel => false;   // âŒ Too late to cancel              â”‚
â”‚      public bool CanModify => false;   // âŒ Package already moving          â”‚
â”‚                                                                              â”‚
â”‚      // Allowed transitions                                                  â”‚
â”‚      public void MarkOutForDelivery(Order context)                           â”‚
â”‚      {                                                                       â”‚
â”‚          if (context.DriverId == null)                                       â”‚
â”‚              throw new OrderException("Driver must be assigned");            â”‚
â”‚                                                                              â”‚
â”‚          context.OutForDeliveryAt = DateTime.UtcNow;                         â”‚
â”‚          context.TransitionTo(new OutForDeliveryState());                    â”‚
â”‚      }                                                                       â”‚
â”‚                                                                              â”‚
â”‚      public void MarkException(Order context, ExceptionType type)            â”‚
â”‚      {                                                                       â”‚
â”‚          context.ExceptionType = type;                                       â”‚
â”‚          context.ExceptionAt = DateTime.UtcNow;                              â”‚
â”‚          context.TransitionTo(new ExceptionState());                         â”‚
â”‚      }                                                                       â”‚
â”‚                                                                              â”‚
â”‚      // Invalid transitions                                                  â”‚
â”‚      public void Cancel(Order context, string reason)                        â”‚
â”‚          => throw new InvalidStateTransitionException(                       â”‚
â”‚              Status, OrderStatus.CANCELLED,                                  â”‚
â”‚              "Cannot cancel order in transit. Contact carrier.");            â”‚
â”‚                                                                              â”‚
â”‚      public void Confirm(Order context)                                      â”‚
â”‚          => throw new InvalidStateTransitionException(                       â”‚
â”‚              Status, OrderStatus.CONFIRMED, "Already past confirmation");    â”‚
â”‚                                                                              â”‚
â”‚      // ... other invalid transitions                                        â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš–ï¸ State vs Strategy Pattern

### Key Differences (å…³é”®åŒºåˆ«)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STATE vs STRATEGY PATTERN COMPARISON                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚        STATE PATTERN           â”‚       STRATEGY PATTERN         â”‚        â”‚
â”‚  â”‚        çŠ¶æ€æ¨¡å¼                 â”‚        ç­–ç•¥æ¨¡å¼                â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚                                â”‚                                â”‚        â”‚
â”‚  â”‚  PURPOSE:                      â”‚  PURPOSE:                      â”‚        â”‚
â”‚  â”‚  Change behavior based on      â”‚  Choose algorithm at runtime   â”‚        â”‚
â”‚  â”‚  internal state                â”‚  based on external factors     â”‚        â”‚
â”‚  â”‚                                â”‚                                â”‚        â”‚
â”‚  â”‚  æ ¹æ®å†…éƒ¨çŠ¶æ€æ”¹å˜è¡Œä¸º            â”‚  æ ¹æ®å¤–éƒ¨å› ç´ é€‰æ‹©ç®—æ³•            â”‚        â”‚
â”‚  â”‚                                â”‚                                â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚                                â”‚                                â”‚        â”‚
â”‚  â”‚  WHO CHANGES:                  â”‚  WHO CHANGES:                  â”‚        â”‚
â”‚  â”‚  State changes ITSELF          â”‚  Client changes strategy       â”‚        â”‚
â”‚  â”‚  (internal transitions)        â”‚  (external selection)          â”‚        â”‚
â”‚  â”‚                                â”‚                                â”‚        â”‚
â”‚  â”‚  çŠ¶æ€è‡ªå·±æ”¹å˜è‡ªå·±                â”‚  å®¢æˆ·ç«¯é€‰æ‹©ç­–ç•¥                 â”‚        â”‚
â”‚  â”‚                                â”‚                                â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚                                â”‚                                â”‚        â”‚
â”‚  â”‚  STATE AWARENESS:              â”‚  STATE AWARENESS:              â”‚        â”‚
â”‚  â”‚  States know about each other  â”‚  Strategies independent        â”‚        â”‚
â”‚  â”‚  (for transitions)             â”‚  (don't know each other)       â”‚        â”‚
â”‚  â”‚                                â”‚                                â”‚        â”‚
â”‚  â”‚  çŠ¶æ€ä¹‹é—´ç›¸äº’äº†è§£                â”‚  ç­–ç•¥ä¹‹é—´ç›¸äº’ç‹¬ç«‹               â”‚        â”‚
â”‚  â”‚                                â”‚                                â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚                                â”‚                                â”‚        â”‚
â”‚  â”‚  EXAMPLE:                      â”‚  EXAMPLE:                      â”‚        â”‚
â”‚  â”‚  Order lifecycle               â”‚  Route calculation algorithm   â”‚        â”‚
â”‚  â”‚  (CREATED â†’ CONFIRMED â†’ ...)   â”‚  (FastestRoute, CheapestRoute) â”‚        â”‚
â”‚  â”‚                                â”‚                                â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                              â”‚
â”‚  VISUAL COMPARISON:                                                          â”‚
â”‚                                                                              â”‚
â”‚  STATE PATTERN:                    STRATEGY PATTERN:                         â”‚
â”‚  â”Œâ”€â”€â”€â” â†’ â”Œâ”€â”€â”€â” â†’ â”Œâ”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ A â”‚   â”‚ B â”‚   â”‚ C â”‚            â”‚                   â”‚                     â”‚
â”‚  â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜            â”‚     Context       â”‚                     â”‚
â”‚    â”‚       â”‚       â”‚              â”‚                   â”‚                     â”‚
â”‚  Object progresses through        â”‚   uses ONE of:    â”‚                     â”‚
â”‚  states over its lifetime         â”‚                   â”‚                     â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                     â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”                           â”‚
â”‚                                     â–¼     â–¼     â–¼                           â”‚
â”‚                                   â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                         â”‚
â”‚                                   â”‚ A â”‚ â”‚ B â”‚ â”‚ C â”‚                         â”‚
â”‚                                   â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜                         â”‚
â”‚                                   Client picks one                          â”‚
â”‚                                   strategy to use                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### When to Use Each (ä½•æ—¶ä½¿ç”¨)

| Use State Pattern When | Use Strategy Pattern When |
|------------------------|---------------------------|
| Object has lifecycle with distinct states | Need interchangeable algorithms |
| Behavior depends on current state | Client should choose algorithm |
| Valid operations differ by state | Algorithms are independent |
| State transitions follow rules | No notion of "current state" |
| **Example**: Order processing | **Example**: Routing algorithms |

### Can They Coexist? (èƒ½å¦å…±å­˜?)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YES! STATE + STRATEGY COMBINED                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  In Order Processing, we use BOTH:                                          â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         Order (Context)                              â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  - _state: IOrderState             â† STATE PATTERN                  â”‚    â”‚
â”‚  â”‚  - _dispatchStrategy: IDispatchStrategy  â† STRATEGY PATTERN         â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  + Dispatch()                                                       â”‚    â”‚
â”‚  â”‚    {                                                                â”‚    â”‚
â”‚  â”‚        _state.Dispatch(this);      // State validates transition    â”‚    â”‚
â”‚  â”‚        // Inside ConfirmedState.Dispatch():                         â”‚    â”‚
â”‚  â”‚        var carrier = _dispatchStrategy.SelectCarrier(this);         â”‚    â”‚
â”‚  â”‚        // Strategy selects carrier algorithm                        â”‚    â”‚
â”‚  â”‚    }                                                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  The patterns work at different levels:                                      â”‚
â”‚  â€¢ State Pattern: Controls WHAT operations are valid                        â”‚
â”‚  â€¢ Strategy Pattern: Controls HOW operations are performed                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Implementation Variations

### Variation 1: State as Singleton (çŠ¶æ€å•ä¾‹)

```
Use Case: States are stateless (no instance data)
ä¼˜ç‚¹: Memory efficient
ç¼ºç‚¹: Cannot store state-specific data

public class CreatedState : IOrderState
{
    // Singleton instance
    public static readonly CreatedState Instance = new();
    private CreatedState() { }  // Private constructor
    
    // All methods work with context data only
}

// Usage:
order.TransitionTo(CreatedState.Instance);
```

### Variation 2: State with Instance Data (å¸¦å®ä¾‹æ•°æ®çš„çŠ¶æ€)

```
Use Case: Each state needs to store data
ä¼˜ç‚¹: State can hold metadata
ç¼ºç‚¹: More memory per order

public class ReturnInTransitState : IOrderState
{
    public string ReturnTrackingNumber { get; }
    public string ReturnCarrierCode { get; }
    public DateTime PickupDate { get; }
    
    public ReturnInTransitState(string trackingNo, string carrier, DateTime pickup)
    {
        ReturnTrackingNumber = trackingNo;
        ReturnCarrierCode = carrier;
        PickupDate = pickup;
    }
}

// Usage:
order.TransitionTo(new ReturnInTransitState("SF123", "SF", DateTime.Today));
```

### Variation 3: State Machine Library (çŠ¶æ€æœºåº“)

```
Use Case: Complex state machines with many transitions
Tools: Stateless, Automatonymous

Using Stateless library:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var orderMachine = new StateMachine<Order, OrderStatus, OrderTrigger>(
    () => order.Status,
    s => order.Status = s);

orderMachine.Configure(OrderStatus.CREATED)
    .Permit(OrderTrigger.PaymentReceived, OrderStatus.CONFIRMED)
    .Permit(OrderTrigger.CustomerCancels, OrderStatus.CANCELLED);

orderMachine.Configure(OrderStatus.CONFIRMED)
    .Permit(OrderTrigger.CarrierBooked, OrderStatus.DISPATCHED)
    .Permit(OrderTrigger.CustomerCancels, OrderStatus.CANCELLED)
    .OnEntry(() => NotifyCustomer(order));

orderMachine.Configure(OrderStatus.IN_TRANSIT)
    .Ignore(OrderTrigger.CustomerCancels);  // Cannot cancel

// Fire trigger
orderMachine.Fire(OrderTrigger.PaymentReceived);
```

### Variation 4: Event-Sourced State (äº‹ä»¶æº¯æºçŠ¶æ€)

```
Use Case: Need complete audit trail
Used by: äº¬ä¸œé’é¾™ç³»ç»Ÿ, SF Express

public class Order : AggregateRoot
{
    private IOrderState _state = new CreatedState();
    
    public void Apply(OrderConfirmedEvent e)
    {
        _state = new ConfirmedState();
        ConfirmedAt = e.OccurredAt;
    }
    
    public void Apply(OrderDispatchedEvent e)
    {
        _state = new DispatchedState();
        TrackingNumber = e.TrackingNumber;
        CarrierId = e.CarrierId;
    }
    
    // Rebuild state by replaying events
    public static Order FromHistory(IEnumerable<DomainEvent> events)
    {
        var order = new Order();
        foreach (var e in events)
            order.Apply((dynamic)e);
        return order;
    }
}
```

---

## âš ï¸ Anti-Patterns to Avoid

### Anti-Pattern 1: God State (ä¸Šå¸çŠ¶æ€)

```
âŒ BAD: One state that handles everything

public class AllInOneState : IOrderState
{
    public void Handle(Order order, string action)
    {
        switch (action)
        {
            case "confirm": // ...
            case "dispatch": // ...
            case "deliver": // ...
            // Back to switch statements!
        }
    }
}

âœ… GOOD: Separate state class per state
```

### Anti-Pattern 2: Leaking State Logic (çŠ¶æ€é€»è¾‘æ³„æ¼)

```
âŒ BAD: Context checks state before delegating

public class Order
{
    public void Cancel(string reason)
    {
        // DON'T DO THIS - logic should be in state
        if (_state.Status == OrderStatus.IN_TRANSIT)
            throw new Exception("Cannot cancel");
            
        _state.Cancel(this, reason);
    }
}

âœ… GOOD: Let state handle the logic

public class Order
{
    public void Cancel(string reason)
    {
        _state.Cancel(this, reason);  // State decides
    }
}
```

### Anti-Pattern 3: Circular Dependencies (å¾ªç¯ä¾èµ–)

```
âŒ BAD: States creating each other directly

public class ConfirmedState : IOrderState
{
    public void Dispatch(Order context)
    {
        // Direct coupling to concrete state
        context.TransitionTo(new DispatchedState());
    }
}

âœ… GOOD: Use factory or DI

public class ConfirmedState : IOrderState
{
    private readonly IOrderStateFactory _factory;
    
    public void Dispatch(Order context)
    {
        context.TransitionTo(_factory.Create(OrderStatus.DISPATCHED));
    }
}
```

### Anti-Pattern 4: Missing Transition Validation (ç¼ºå°‘è½¬æ¢éªŒè¯)

```
âŒ BAD: Allow any transition

public class ConfirmedState : IOrderState
{
    public void Deliver(Order context)
    {
        // Skips DISPATCHED and IN_TRANSIT!
        context.TransitionTo(new DeliveredState());
    }
}

âœ… GOOD: Enforce valid transitions only

public class ConfirmedState : IOrderState
{
    public void Deliver(Order context)
    {
        throw new InvalidStateTransitionException(
            Status, OrderStatus.DELIVERED,
            "Must dispatch and ship before delivery");
    }
}
```

---

## ğŸš€ Advanced Topics

### Topic 1: Hierarchical State Machines (å±‚æ¬¡çŠ¶æ€æœº)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HIERARCHICAL STATE MACHINE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Use Case: States have sub-states (like äº¬ä¸œç‰©æµä»“é…ä¸€ä½“åŒ–)                   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         IN_WAREHOUSE (å¤§çŠ¶æ€)                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚    â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚   â”‚ALLOCATEDâ”‚ â”€â–¶ â”‚ PICKING â”‚ â”€â–¶ â”‚ PACKED  â”‚ â”€â–¶ â”‚HANDED_ â”‚   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚   â”‚ å·²åˆ†é…   â”‚    â”‚ æ‹£è´§ä¸­   â”‚    â”‚ å·²æ‰“åŒ…   â”‚    â”‚  OFF    â”‚   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ å·²äº¤æ¥   â”‚    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                   â”‚         â”‚
â”‚                                                                   â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         IN_TRANSIT (å¤§çŠ¶æ€)                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚   â”‚ HUB_1   â”‚ â”€> â”‚ HUB_2   â”‚ â”€> â”‚  LAST   â”‚                   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚   â”‚ è½¬è¿ä¸­å¿ƒ1â”‚    â”‚ è½¬è¿ä¸­å¿ƒ2â”‚   â”‚  MILE   â”‚                   â”‚  â”‚     â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ æœ«ç«¯æ´¾é€ â”‚                   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â”‚  Implementation: Composite State Pattern                                    â”‚
â”‚  â€¢ Parent state delegates to active sub-state                               â”‚
â”‚  â€¢ Sub-states can transition within parent                                  â”‚
â”‚  â€¢ Parent handles transitions to other parent states                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Topic 2: Concurrent States (å¹¶å‘çŠ¶æ€)

```
Use Case: Order has multiple independent aspects
Example: Payment status + Fulfillment status

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Order                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Payment Region     â”‚    â”‚  Fulfillment Region  â”‚           â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚           â”‚
â”‚  â”‚  PENDING             â”‚    â”‚  CREATED             â”‚           â”‚
â”‚  â”‚    â”‚                 â”‚    â”‚    â”‚                 â”‚           â”‚
â”‚  â”‚    â–¼                 â”‚    â”‚    â–¼                 â”‚           â”‚
â”‚  â”‚  PAID                â”‚    â”‚  DISPATCHED          â”‚           â”‚
â”‚  â”‚    â”‚                 â”‚    â”‚    â”‚                 â”‚           â”‚
â”‚  â”‚    â–¼                 â”‚    â”‚    â–¼                 â”‚           â”‚
â”‚  â”‚  REFUNDED            â”‚    â”‚  DELIVERED           â”‚           â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚  States operate independently:                                  â”‚
â”‚  â€¢ Can be PAID + DISPATCHED                                     â”‚
â”‚  â€¢ Can be REFUNDED + DELIVERED (customer returned)              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Topic 3: State Persistence (çŠ¶æ€æŒä¹…åŒ–)

```
Options for saving state to database:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Option 1: Enum column (simple)
  Orders table: Status INT NOT NULL

Option 2: State table (flexible)
  OrderStates table: OrderId, StateType, EnteredAt, Data (JSON)

Option 3: Event sourcing (complete history)
  OrderEvents table: OrderId, EventType, EventData, OccurredAt
  
Recommendation:
â€¢ Simple workflows: Enum column
â€¢ Need audit: Event sourcing
â€¢ Complex sub-states: State table with JSON
```

---

## ğŸ‡¨ğŸ‡³ Chinese Tech References

### Industry Examples (è¡Œä¸šæ¡ˆä¾‹)

| Company | State Machine Complexity | Key Learning |
|---------|--------------------------|--------------|
| äº¬ä¸œç‰©æµ | 50+ states (ä»“é…ä¸€ä½“åŒ–) | Hierarchical states for warehouse + delivery |
| é¡ºä¸°é€Ÿè¿ | 30+ states (æ ‡å‡†åŒ–) | Time-bound states with SLA |
| ä¸­é€šå¿«é€’ | 25+ states (ç®€æ´åŒ–) | State + SubStatus for flexibility |
| èœé¸Ÿç½‘ç»œ | 40+ states (ååŒ) | Cross-company state synchronization |

### Chinese Tech Community Resources

| Platform | Search Keywords | Content Type |
|----------|-----------------|--------------|
| CSDN | `è®¢å•çŠ¶æ€æœº è®¾è®¡æ¨¡å¼` | Implementation tutorials |
| æ˜é‡‘ | `çŠ¶æ€æ¨¡å¼ ç‰©æµç³»ç»Ÿ` | Real-world case studies |
| çŸ¥ä¹ | `ç”µå•†è®¢å• çŠ¶æ€ç®¡ç†` | Architecture discussions |
| Gitee | `çŠ¶æ€æœº DDD` | Open source examples |

### Recommended Articles (æ¨èæ–‡ç« )

```
1. "äº¬ä¸œç‰©æµè®¢å•çŠ¶æ€æœºæ¼”è¿›ä¹‹è·¯" - äº¬ä¸œæŠ€æœ¯
   å†…å®¹ï¼šä»ç®€å•æšä¸¾åˆ°50+çŠ¶æ€çš„æ¼”è¿›è¿‡ç¨‹

2. "é¡ºä¸°æ—¶æ•ˆæ‰¿è¯ºèƒŒåçš„çŠ¶æ€ç®¡ç†" - é¡ºä¸°ç§‘æŠ€
   å†…å®¹ï¼šå¦‚ä½•ç”¨çŠ¶æ€æ¨¡å¼å®ç°æ—¶æ•ˆSLA

3. "ä¸­é€šå¿«é€’çŠ¶æ€ç æ ‡å‡†åŒ–å®è·µ" - ä¸­é€šæŠ€æœ¯
   å†…å®¹ï¼šçŠ¶æ€+å­çŠ¶æ€çš„è®¾è®¡æ€è·¯

4. "èœé¸Ÿç½‘ç»œå¤šæ‰¿è¿å•†çŠ¶æ€åŒæ­¥" - é˜¿é‡ŒæŠ€æœ¯
   å†…å®¹ï¼šè·¨å…¬å¸çŠ¶æ€æ˜ å°„ä¸åŒæ­¥
```

---

## ğŸ“ Self-Assessment

### Knowledge Check (çŸ¥è¯†æ£€æŸ¥)

**Q1**: What problem does State Pattern solve?
<details>
<summary>Answer</summary>
Eliminates large switch/if-else statements that check object state before executing behavior. Instead, behavior is encapsulated in state classes.
</details>

**Q2**: Who is responsible for state transitions - the context or the state?
<details>
<summary>Answer</summary>
The state classes initiate transitions (they know what states they can transition to), but the context executes the actual state change via `TransitionTo()`.
</details>

**Q3**: What's the key difference between State and Strategy patterns?
<details>
<summary>Answer</summary>
- State: Object behavior changes as internal state changes (states know each other)
- Strategy: Client chooses algorithm (strategies are independent)
</details>

**Q4**: When would you use a state machine library vs. manual implementation?
<details>
<summary>Answer</summary>
- Manual: Simple state machines (< 10 states), need full control
- Library: Complex state machines, need visualization, configuration-driven
</details>

**Q5**: How do you persist state in a database?
<details>
<summary>Answer</summary>
- Simple: Enum/int column for status
- Audit needed: Event sourcing (store all transitions)
- Complex sub-states: JSON column or separate state table
</details>

### Coding Exercise (ç¼–ç ç»ƒä¹ )

```
Exercise: Implement a simplified Order state machine

Requirements:
1. States: CREATED, CONFIRMED, SHIPPED, DELIVERED, CANCELLED
2. Transitions:
   - CREATED â†’ CONFIRMED (on payment)
   - CREATED â†’ CANCELLED (customer cancels)
   - CONFIRMED â†’ SHIPPED (on dispatch)
   - CONFIRMED â†’ CANCELLED (customer cancels)
   - SHIPPED â†’ DELIVERED (on delivery)
3. SHIPPED and DELIVERED cannot be cancelled

Bonus:
- Add OnEnter/OnExit hooks
- Add transition guards (e.g., cannot confirm without payment)
- Add domain events for each transition

Time: 60 minutes
```

### Architecture Discussion (æ¶æ„è®¨è®º)

```
Scenario: You're designing an order system for a company that:
- Has 15 different order states
- Needs to support returns (reverse logistics)
- Must integrate with 5 different carriers (each with their own status codes)
- Requires complete audit trail
- Handles 100,000 orders/day

Questions:
1. Would you use State Pattern? Why or why not?
2. How would you map carrier statuses to your internal states?
3. How would you persist state changes for audit?
4. How would you handle the complexity of 15 states?

Discuss with your team or write your thoughts.
```

---

## ğŸ”— Related Documents

- **Domain Spec**: [04-ORDER-PROCESSING.md](../core-domains/04-ORDER-PROCESSING.md)
- **Related Pattern**: [STRATEGY-PATTERN.md](STRATEGY-PATTERN.md) - Often confused with State
- **Related Pattern**: [OBSERVER-PATTERN.md](OBSERVER-PATTERN.md) - For state change notifications
- **CQRS Pattern**: [CQRS-PATTERN.md](CQRS-PATTERN.md) - Often used together

---